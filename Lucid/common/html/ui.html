<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Lucid Chat</title>
    <style nonce="__NONCE__">
      :root {
        color-scheme: light dark;
      }
      * {
        box-sizing: border-box;
      }
      html,
      body {
        height: 100%;
      }
      body {
        margin: 0;
        padding: 12px;
        background: var(--vscode-sideBar-background);
        color: var(--vscode-foreground);
        font-family: var(
          --vscode-font-family,
          -apple-system,
          BlinkMacSystemFont,
          sans-serif
        );
        display: flex;
        flex-direction: column;
        overflow: hidden;
      }
      .shell {
        display: flex;
        flex-direction: column;
        gap: 10px;
        flex: 1;
        min-height: 0;
      }
      .messages {
        flex: 1;
        overflow-y: auto;
        padding: 12px;
        border: 1px solid var(--vscode-panel-border);
        border-radius: 6px;
        background: var(--vscode-editor-background);
        box-shadow: inset 0 0 0 1px rgba(255, 255, 255, 0.03);
        display: flex;
        flex-direction: column;
        gap: 8px;
        min-height: 0;
      }
      .composer {
        display: flex;
        flex-direction: column;
        gap: 8px;
      }
      .message {
        display: inline-flex;
        flex-direction: column;
        gap: 6px;
        margin: 0;
        padding: 10px 12px;
        border-radius: 8px;
        background: rgba(255, 255, 255, 0.02);
        align-self: flex-start;
        text-align: left;
        max-width: 100%;
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.15);
      }
      .message.assistant {
        background: rgba(255, 255, 255, 0.02);
      }
      .message.user {
        background: rgba(0, 120, 212, 0.18);
        color: var(--vscode-foreground);
        align-self: flex-end;
        text-align: right;
      }
      .message.system {
        border: 1px dashed var(--vscode-descriptionForeground);
        background: transparent;
        color: var(--vscode-descriptionForeground);
      }
      .message.error {
        border: 1px solid var(--vscode-errorForeground);
        color: var(--vscode-errorForeground);
        background: transparent;
      }
      .message-label {
        font-size: 10px;
        text-transform: uppercase;
        letter-spacing: 0.06em;
        opacity: 0.7;
      }
      .message.user .message-label {
        align-self: flex-end;
      }
      .message-body {
        margin: 0;
        padding: 0;
        background: transparent;
        border: none;
        white-space: normal;
        font-family: var(
          --vscode-editor-font-family,
          Menlo,
          Monaco,
          "Courier New",
          monospace
        );
        font-size: 13px;
        line-height: 1.4;
      }
      .message-body code {
        font-size: 12px;
        padding: 0 4px;
        border-radius: 4px;
        background: rgba(249, 245, 255, 0.1);
      }
      .message-body .code-block {
        margin: 10px 0;
        padding: 12px;
        border-radius: 6px;
        background: rgba(249, 245, 255, 0.05);
        border: 1px solid rgba(255, 255, 255, 0.08);
        overflow-x: auto;
        font-family: var(
          --vscode-editor-font-family,
          Menlo,
          Monaco,
          "Courier New",
          monospace
        );
        font-size: 12px;
        line-height: 1.6;
        position: relative;
        white-space: pre-wrap;
      }
      .message-body .code-block::before {
        content: attr(data-lang);
        position: absolute;
        top: 6px;
        right: 8px;
        font-size: 10px;
        letter-spacing: 0.04em;
        text-transform: uppercase;
        color: var(--vscode-descriptionForeground);
      }
      textarea {
        resize: vertical;
        border-radius: 6px;
        padding: 8px;
        border: 1px solid var(--vscode-input-border, transparent);
        background: var(--vscode-input-background);
        color: var(--vscode-input-foreground);
        font-family: var(
          --vscode-editor-font-family,
          Menlo,
          Monaco,
          "Courier New",
          monospace
        );
        min-height: 80px;
        max-height: 160px;
      }
      .controls {
        display: flex;
        align-items: center;
        flex-wrap: wrap;
        gap: 10px;
      }
      .status {
        display: flex;
        align-items: center;
        gap: 6px;
        color: var(--vscode-descriptionForeground);
        flex: 1;
        min-width: 160px;
      }
      .status[data-level="error"] {
        color: var(--vscode-errorForeground);
      }
      .spinner {
        width: 12px;
        height: 12px;
        border: 2px solid transparent;
        border-top-color: var(--vscode-progressBar-background);
        border-radius: 50%;
        animation: spin 1s linear infinite;
      }
      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }
      button {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        border: none;
        border-radius: 4px;
        padding: 6px 14px;
        font-size: 12px;
        cursor: pointer;
        background: var(--vscode-button-secondaryBackground);
        color: var(--vscode-button-secondaryForeground);
      }
      button.primary {
        background: var(--vscode-button-background);
        color: var(--vscode-button-foreground);
      }
      button:disabled {
        opacity: 0.6;
        cursor: not-allowed;
      }
      button.clear-history {
        background: transparent;
        border: 1px solid var(--vscode-button-secondaryBackground);
        color: var(--vscode-descriptionForeground);
        padding: 4px 10px;
        font-size: 11px;
      }
      button.clear-history:hover {
        background: var(--vscode-button-secondaryHoverBackground);
        border-color: var(--vscode-button-secondaryHoverBackground);
      }
      .icon-plane {
        width: 14px;
        height: 14px;
        fill: currentColor;
        flex-shrink: 0;
      }
      .icon-trash {
        width: 12px;
        height: 12px;
        fill: currentColor;
        flex-shrink: 0;
      }
      /* File search dropdown / list styles to match VS Code look */
      #fileList {
        box-shadow: var(--vscode-widget-shadow, 0 1px 0 rgba(0, 0, 0, 0.1));
        border-radius: 6px;
      }
      .file-list-item {
        padding: 6px 8px;
        border-radius: 4px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 8px;
        color: var(--vscode-foreground);
      }
      .file-list-item:hover {
        background: var(--vscode-list-hoverBackground);
        color: var(--vscode-list-hoverForeground);
      }
      .file-list-item.focused {
        background: var(--vscode-list-activeSelectionBackground);
        color: var(--vscode-list-activeSelectionForeground);
        outline: none;
      }
      #fileList::-webkit-scrollbar {
        height: 8px;
        width: 8px;
      }
      #fileList::-webkit-scrollbar-thumb {
        background: rgba(128, 128, 128, 0.25);
        border-radius: 4px;
      }
      #fileHint {
        font-size: 11px;
        color: var(--vscode-descriptionForeground);
        margin-bottom: 6px;
        display: none;
      }
      /* Message action buttons (Replay / Copy) ‚Äî placed outside the bubble */
      .message-actions-sibling {
        display: flex;
        gap: 6px;
        margin: 6px 0 12px 0;
        justify-content: flex-end;
      }
      .message-actions-sibling button {
        width: 36px;
        height: 28px;
        padding: 4px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        border-radius: 6px;
        cursor: pointer;
        background: transparent;
        border: 1px solid rgba(255, 255, 255, 0.04);
        color: var(--vscode-foreground);
      }
      .message-actions-sibling button:hover {
        background: rgba(255, 255, 255, 0.02);
      }
      .message-actions-sibling svg {
        width: 16px;
        height: 16px;
        fill: currentColor;
      }
      .message-separator {
        height: 1px;
        background: rgba(128, 128, 128, 0.08);
        opacity: 1;
        margin: 12px 0;
        border-radius: 2px;
      }
      /* Code block action buttons */
      .code-block-wrapper {
        position: relative;
        margin: 10px 0;
      }
      .code-block-actions {
        position: absolute;
        top: 4px;
        right: 4px;
        display: flex;
        gap: 4px;
        opacity: 0;
        transition: opacity 0.2s;
        z-index: 10;
      }
      .code-block-wrapper:hover .code-block-actions {
        opacity: 1;
      }
      .code-block-actions button {
        width: 26px;
        height: 26px;
        padding: 4px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        border-radius: 4px;
        cursor: pointer;
        background: var(--vscode-button-secondaryBackground);
        border: none;
        color: var(--vscode-button-secondaryForeground);
        font-size: 10px;
      }
      .code-block-actions button:hover {
        background: var(--vscode-button-background);
        color: var(--vscode-button-foreground);
      }
      .code-block-actions button svg {
        width: 14px;
        height: 14px;
        fill: currentColor;
      }
      .code-block-actions button[title]::after {
        content: attr(title);
      }
      /* Selection context display */
      .selection-context {
        background: rgba(0, 120, 212, 0.12);
        border: 1px solid rgba(0, 120, 212, 0.3);
        border-radius: 6px;
        padding: 8px;
        margin-bottom: 8px;
        font-size: 12px;
      }
      .selection-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 6px;
      }
      .selection-header .file-info {
        font-weight: 600;
        color: var(--vscode-foreground);
      }
      .selection-header .line-info {
        font-size: 11px;
        color: var(--vscode-descriptionForeground);
      }
      .selection-header .clear-btn {
        background: transparent;
        border: none;
        cursor: pointer;
        padding: 2px 6px;
        font-size: 11px;
        color: var(--vscode-descriptionForeground);
        border-radius: 4px;
      }
      .selection-header .clear-btn:hover {
        background: rgba(255, 255, 255, 0.1);
        color: var(--vscode-foreground);
      }
      .selection-code {
        max-height: 100px;
        overflow: auto;
        background: rgba(0, 0, 0, 0.15);
        border-radius: 4px;
        padding: 6px 8px;
        font-family: var(
          --vscode-editor-font-family,
          Menlo,
          Monaco,
          "Courier New",
          monospace
        );
        font-size: 11px;
        white-space: pre-wrap;
        word-break: break-all;
      }
      /* Mode Toggle Styles */
      .mode-toggle {
        display: flex;
        gap: 4px;
        margin-bottom: 8px;
        padding: 4px;
        background: var(--vscode-input-background);
        border-radius: 6px;
        border: 1px solid var(--vscode-input-border);
      }
      .mode-btn {
        flex: 1;
        padding: 8px 12px;
        border: none;
        border-radius: 4px;
        background: transparent;
        color: var(--vscode-descriptionForeground);
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 6px;
        font-size: 12px;
        font-weight: 500;
        transition: all 0.15s ease;
      }
      .mode-btn.active {
        background: var(--vscode-button-background);
        color: var(--vscode-button-foreground);
      }
      .mode-btn:hover:not(.active) {
        background: rgba(255, 255, 255, 0.08);
      }
      .mode-btn svg {
        width: 14px;
        height: 14px;
        fill: currentColor;
      }
      .mode-indicator {
        font-size: 11px;
        color: var(--vscode-descriptionForeground);
        margin-bottom: 6px;
        display: flex;
        align-items: center;
        gap: 4px;
      }
      .mode-indicator.agent {
        color: var(--vscode-charts-orange);
      }
      /* Agent pending changes panel */
      .agent-changes {
        background: rgba(255, 165, 0, 0.1);
        border: 1px solid rgba(255, 165, 0, 0.3);
        border-radius: 6px;
        padding: 10px;
        margin: 8px 0;
      }
      .agent-changes-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 8px;
        font-weight: 600;
        color: var(--vscode-foreground);
      }
      .agent-changes-file {
        font-size: 12px;
        color: var(--vscode-descriptionForeground);
        margin-bottom: 6px;
      }
      .agent-changes-actions {
        display: flex;
        gap: 8px;
        margin-top: 8px;
      }
      .agent-changes-actions button {
        flex: 1;
        padding: 6px 12px;
        font-size: 12px;
      }
      .btn-approve {
        background: var(--vscode-button-background) !important;
        color: var(--vscode-button-foreground) !important;
      }
      .btn-reject {
        background: transparent !important;
        border: 1px solid var(--vscode-button-secondaryBackground) !important;
      }

      /* CLI Commands Panel */
      #cliCommandsContainer {
        background: var(--vscode-editor-background);
        border: 1px solid var(--vscode-panel-border);
        border-radius: 6px;
        padding: 12px;
        margin-bottom: 12px;
      }
      .cli-commands-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 8px;
        font-weight: 600;
        color: var(--vscode-foreground);
      }
      .cli-command-item {
        background: var(--vscode-textCodeBlock-background);
        border: 1px solid var(--vscode-panel-border);
        border-radius: 4px;
        padding: 8px;
        margin-bottom: 8px;
        font-family: monospace;
        font-size: 12px;
        position: relative;
      }
      .cli-command-item.executed {
        opacity: 0.6;
        border-left: 3px solid #4caf50;
      }
      .cli-command-item.current {
        border-left: 3px solid #2196f3;
        background: var(--vscode-editor-selectionBackground);
      }
      .cli-command-text {
        color: var(--vscode-textPreformat-foreground);
        word-break: break-all;
        margin-bottom: 6px;
      }
      .cli-command-actions {
        display: flex;
        gap: 6px;
      }
      .cli-command-actions button {
        padding: 4px 10px;
        font-size: 11px;
        border-radius: 3px;
      }
      .btn-run-command {
        background: var(--vscode-button-background) !important;
        color: var(--vscode-button-foreground) !important;
      }
      .btn-copy-command {
        background: transparent !important;
        border: 1px solid var(--vscode-button-secondaryBackground) !important;
      }
      .btn-run-all {
        background: var(--vscode-button-background) !important;
        color: var(--vscode-button-foreground) !important;
        font-weight: 600;
      }
    </style>
  </head>
  <body>
    <div class="shell">
      <div id="messages" class="messages" aria-live="polite"></div>
      <div class="composer">
        <!-- Selection Context Display -->
        <div
          id="selectionContext"
          class="selection-context"
          style="display: none"
        >
          <div class="selection-header">
            <span class="file-info" id="selectionFileInfo"></span>
            <span class="line-info" id="selectionLineInfo"></span>
            <button
              class="clear-btn"
              id="clearSelection"
              title="Clear selection"
            >
              ‚úï
            </button>
          </div>
          <div class="selection-code" id="selectionCode"></div>
        </div>
        <div
          id="activeEditorName"
          style="
            font-size: 12px;
            font-weight: 600;
            margin-bottom: 6px;
            color: var(--vscode-descriptionForeground);
          "
        ></div>
        <div
          id="activeFiles"
          style="display: flex; gap: 6px; flex-wrap: wrap; margin-bottom: 6px"
        ></div>
        <input
          id="fileSearch"
          placeholder="Filter files..."
          style="
            width: 100%;
            padding: 6px;
            margin-bottom: 6px;
            border-radius: 4px;
            border: 1px solid var(--vscode-input-border);
            background: var(--vscode-input-background);
            color: var(--vscode-input-foreground);
          "
        />
        <div id="fileHint">‚Üë/‚Üì select ‚Äî Enter attach</div>
        <div
          id="fileList"
          style="
            display: none;
            max-height: 170px;
            overflow: auto;
            margin-bottom: 8px;
            border: 1px solid rgba(255, 255, 255, 0.03);
            padding: 6px;
            border-radius: 6px;
            background: var(--vscode-sideBar-background);
          "
        ></div>

        <!-- Mode Toggle -->
        <div class="mode-toggle" id="modeToggle">
          <button
            id="askModeBtn"
            class="mode-btn active"
            data-mode="ask"
            title="Ask Mode - Get answers and suggestions"
          >
            <svg viewBox="0 0 24 24">
              <path
                d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm0 14H6l-2 2V4h16v12z"
              />
            </svg>
            <span>Ask</span>
          </button>
          <button
            id="agentModeBtn"
            class="mode-btn"
            data-mode="agent"
            title="Agent Mode - AI applies changes with your approval"
          >
            <svg viewBox="0 0 24 24">
              <path
                d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"
              />
            </svg>
            <span>Agent</span>
          </button>
        </div>

        <!-- Agent Pending Changes Container -->
        <div id="agentChangesContainer" style="display: none"></div>

        <!-- CLI Commands Container -->
        <div id="cliCommandsContainer" style="display: none"></div>

        <div class="mode-indicator" id="modeIndicator">
          <span>üí¨ Ask Mode</span>
        </div>

        <textarea id="prompt" placeholder="Ask your local model..."></textarea>
        <div class="controls">
          <div class="status" id="status" data-level="info">
            <div id="spinner" class="spinner" hidden></div>
            <span id="statusText">Idle</span>
          </div>
          <button
            id="clearHistory"
            type="button"
            class="clear-history"
            aria-label="Clear chat history"
            title="Clear chat history"
          >
            <svg
              class="icon-trash"
              viewBox="0 0 24 24"
              role="presentation"
              focusable="false"
            >
              <path
                d="M9 3v1H4v2h1v13c0 1.1.9 2 2 2h10c1.1 0 2-.9 2-2V6h1V4h-5V3H9zm0 5h2v9H9V8zm4 0h2v9h-2V8z"
              ></path>
            </svg>
            <span>Clear</span>
          </button>
          <button
            id="send"
            type="button"
            class="primary"
            aria-label="Send prompt"
          >
            <svg
              class="icon-plane"
              viewBox="0 0 24 24"
              role="presentation"
              focusable="false"
            >
              <path
                d="M2.4 11.2l17.3-7.7c.9-.4 1.8.5 1.4 1.4L13.4 22.2c-.4.9-1.8.8-2-.2l-1.7-6.1-6.1-1.7c-1-.3-1.1-1.6-.2-2zM18 6.6L6.9 11.5l3.5 1 .9 3.5L18 6.6z"
              ></path>
            </svg>
            <span>Send</span>
          </button>
        </div>
      </div>
    </div>

    <script nonce="__NONCE__">
      (function () {
        // HostBridge: normalize messaging between VS Code (acquireVsCodeApi)
        // and Visual Studio / WebView2 (chrome.webview). Use HostBridge.postMessage
        // and HostBridge.onMessage in the UI code so the same HTML can run on both hosts.
        var HostBridge = (function () {
          var vscodeApi = null;
          try {
            if (typeof acquireVsCodeApi === "function") {
              vscodeApi = acquireVsCodeApi();
            }
          } catch (e) {
            /* not VS Code */
          }

          // Expose VS Code API for state management
          function getState() {
            return vscodeApi ? vscodeApi.getState() : null;
          }

          function setState(state) {
            if (vscodeApi) {
              vscodeApi.setState(state);
            }
          }

          function postMessage(msg) {
            try {
              if (vscodeApi && typeof vscodeApi.postMessage === "function") {
                vscodeApi.postMessage(msg);
                return;
              }
              if (
                window.chrome &&
                chrome.webview &&
                typeof chrome.webview.postMessage === "function"
              ) {
                chrome.webview.postMessage(msg);
                return;
              }
              console.warn(
                "HostBridge: no host API available to post message",
                msg
              );
            } catch (e) {
              console.error("HostBridge.postMessage error", e);
            }
          }

          function onMessage(cb) {
            // VS Code messages arrive via window 'message' event with data in event.data
            window.addEventListener("message", function (ev) {
              try {
                cb(ev && ev.data ? ev.data : ev);
              } catch (e) {
                console.error(e);
              }
            });

            // WebView2 messages via chrome.webview
            try {
              if (
                window.chrome &&
                chrome.webview &&
                typeof chrome.webview.addEventListener === "function"
              ) {
                chrome.webview.addEventListener("message", function (ev) {
                  try {
                    cb(ev && ev.data ? ev.data : ev);
                  } catch (e) {
                    console.error(e);
                  }
                });
              }
            } catch (e) {
              /* ignore if not present */
            }
          }

          return { postMessage, onMessage, getState, setState };
        })();

        var messages = document.getElementById("messages");
        var promptInput = document.getElementById("prompt");
        var sendBtn = document.getElementById("send");
        var clearHistoryBtn = document.getElementById("clearHistory");
        var statusRoot = document.getElementById("status");
        var statusText = document.getElementById("statusText");
        var spinner = document.getElementById("spinner");
        var fileLabel = document.getElementById("fileLabel");
        var activeEditorName = document.getElementById("activeEditorName");
        var activeFilesRoot = document.getElementById("activeFiles");
        var fileSearch = document.getElementById("fileSearch");
        var fileListRoot = document.getElementById("fileList");
        var fileHint = document.getElementById("fileHint");

        // Mode toggle elements
        var modeToggle = document.getElementById("modeToggle");
        var askModeBtn = document.getElementById("askModeBtn");
        var agentModeBtn = document.getElementById("agentModeBtn");
        var modeIndicator = document.getElementById("modeIndicator");
        var agentChangesContainer = document.getElementById(
          "agentChangesContainer"
        );

        // Current mode state: "ask" or "agent"
        var currentMode = "ask";

        // Selection context elements
        var selectionContext = document.getElementById("selectionContext");
        var selectionFileInfo = document.getElementById("selectionFileInfo");
        var selectionLineInfo = document.getElementById("selectionLineInfo");
        var selectionCode = document.getElementById("selectionCode");
        var clearSelectionBtn = document.getElementById("clearSelection");

        // Current selection state
        var currentSelection = {
          hasSelection: false,
          selectedText: "",
          fileName: "",
          language: "",
          startLine: 0,
          endLine: 0,
        };

        // CLI commands state
        var detectedCommands = [];
        var currentCommandIndex = 0;
        var commandsExecuted = [];

        // CLI commands state
        var detectedCommands = [];
        var currentCommandIndex = 0;
        var commandsExecuted = [];

        if (
          !messages ||
          !promptInput ||
          !sendBtn ||
          !statusRoot ||
          !statusText ||
          !spinner ||
          !activeEditorName ||
          !activeFilesRoot ||
          !fileSearch ||
          !fileListRoot ||
          !fileHint
        ) {
          var missing = [];
          if (!messages) missing.push("messages");
          if (!promptInput) missing.push("prompt");
          if (!sendBtn) missing.push("send");
          if (!statusRoot) missing.push("status");
          if (!statusText) missing.push("statusText");
          if (!spinner) missing.push("spinner");
          if (!fileLabel) missing.push("fileLabel (optional)");
          if (!activeEditorName) missing.push("activeEditorName");
          if (!activeFilesRoot) missing.push("activeFiles");
          if (!fileSearch) missing.push("fileSearch");
          if (!fileListRoot) missing.push("fileList");
          if (!fileHint) missing.push("fileHint");

          // Console with structure for devtools
          console.error(
            "Lucid Chat: missing required DOM nodes:",
            missing.join(", "),
            {
              messagesPresent: !!messages,
              promptPresent: !!promptInput,
              sendPresent: !!sendBtn,
              statusPresent: !!statusRoot,
              statusTextPresent: !!statusText,
              spinnerPresent: !!spinner,
              fileLabelPresent: !!fileLabel,
              fileHintPresent: !!fileHint,
              fileListPresent: !!fileListRoot,
            }
          );

          // Notify extension host for centralized logging / telemetry
          try {
            HostBridge.postMessage({
              type: "error",
              text: "Webview initialization failed: missing DOM nodes",
              nodes: missing,
            });
          } catch (e) {
            /* ignore post failures */
          }

          // Try to show a visible error in the messages pane if available
          try {
            if (messages) {
              var errBlock = document.createElement("div");
              errBlock.className = "message error";
              var lbl = document.createElement("div");
              lbl.className = "message-label";
              lbl.textContent = "Error";
              errBlock.appendChild(lbl);
              var body = document.createElement("div");
              body.className = "message-body";
              body.textContent =
                "Webview failed to initialize. Missing nodes: " +
                missing.join(", ");
              errBlock.appendChild(body);
              messages.appendChild(errBlock);
            }
          } catch (e) {
            /* ignore UI errors */
          }

          return;
        }

        function setEditorLabel(text) {
          try {
            if (fileLabel) fileLabel.textContent = text || "";
            if (activeEditorName) activeEditorName.textContent = text || "";
          } catch (e) {
            /* ignore */
          }
        }

        // Selection context management
        function updateSelectionDisplay(data) {
          try {
            if (!data || !data.hasSelection) {
              // Hide selection context
              if (selectionContext) selectionContext.style.display = "none";
              currentSelection.hasSelection = false;
              currentSelection.selectedText = "";
              return;
            }

            // Update current selection state
            currentSelection = {
              hasSelection: true,
              selectedText: data.selectedText || "",
              fileName: data.fileName || "",
              language: data.language || "",
              startLine: data.startLine || 0,
              endLine: data.endLine || 0,
            };

            // Show selection context
            if (selectionContext) selectionContext.style.display = "block";
            if (selectionFileInfo)
              selectionFileInfo.textContent =
                data.fileName + " (" + data.language + ")";
            if (selectionLineInfo) {
              if (data.startLine === data.endLine) {
                selectionLineInfo.textContent = "Line " + data.startLine;
              } else {
                selectionLineInfo.textContent =
                  "Lines " + data.startLine + "-" + data.endLine;
              }
            }
            if (selectionCode) {
              // Truncate if too long
              var displayText = data.selectedText || "";
              if (displayText.length > 500) {
                displayText = displayText.substring(0, 500) + "...";
              }
              selectionCode.textContent = displayText;
            }

            // Save state when selection changes
            saveState();
          } catch (e) {
            console.error("updateSelectionDisplay error", e);
          }
        }

        function clearSelection() {
          currentSelection = {
            hasSelection: false,
            selectedText: "",
            fileName: "",
            language: "",
            startLine: 0,
            endLine: 0,
          };
          if (selectionContext) selectionContext.style.display = "none";

          // Save state when selection is cleared
          saveState();
        }

        // Clear selection button handler
        if (clearSelectionBtn) {
          clearSelectionBtn.addEventListener("click", function () {
            clearSelection();
          });
        }

        // ============= MODE TOGGLE FUNCTIONS =============

        function setMode(mode) {
          currentMode = mode;

          // Update button states
          if (askModeBtn) {
            askModeBtn.classList.toggle("active", mode === "ask");
          }
          if (agentModeBtn) {
            agentModeBtn.classList.toggle("active", mode === "agent");
          }

          // Update indicator
          if (modeIndicator) {
            if (mode === "agent") {
              modeIndicator.innerHTML =
                "<span>ü§ñ Agent Mode - AI will apply changes with approval</span>";
              modeIndicator.className = "mode-indicator agent";
            } else {
              modeIndicator.innerHTML = "<span>üí¨ Ask Mode</span>";
              modeIndicator.className = "mode-indicator";
            }
          }

          // Update placeholder
          if (promptInput) {
            if (mode === "agent") {
              promptInput.placeholder =
                "Tell the agent what to do (e.g., 'Add error handling to this function')...";
            } else {
              promptInput.placeholder = "Ask your local model...";
            }
          }

          // Save state when mode changes
          saveState();
        }

        // Mode button handlers
        if (askModeBtn) {
          askModeBtn.addEventListener("click", function () {
            setMode("ask");
          });
        }
        if (agentModeBtn) {
          agentModeBtn.addEventListener("click", function () {
            setMode("agent");
          });
        }

        // ============= AGENT CHANGES DISPLAY =============

        var pendingAgentChange = null;

        function showAgentChanges(data) {
          if (!agentChangesContainer) return;

          pendingAgentChange = data;

          var html = '<div class="agent-changes">';
          html += '<div class="agent-changes-header">';
          html += "<span>ü§ñ Proposed Changes</span>";
          html += "</div>";
          html +=
            '<div class="agent-changes-file">üìÑ ' +
            (data.fileName || "Unknown file") +
            "</div>";
          html +=
            '<div class="selection-code" style="max-height: 150px;">' +
            escapeHtmlBasic(data.preview || "") +
            "</div>";
          html += '<div class="agent-changes-actions">';
          html +=
            '<button class="btn-reject" id="rejectChange">‚úï Reject</button>';
          html +=
            '<button id="viewDiffChange" style="flex: 1;">üëÅÔ∏è View Diff</button>';
          html +=
            '<button class="btn-approve" id="approveChange">‚úì Apply & Save</button>';
          html += "</div>";
          html += "</div>";

          agentChangesContainer.innerHTML = html;
          agentChangesContainer.style.display = "block";

          // Attach handlers
          var approveBtn = document.getElementById("approveChange");
          var rejectBtn = document.getElementById("rejectChange");
          var viewDiffBtn = document.getElementById("viewDiffChange");

          if (approveBtn) {
            approveBtn.addEventListener("click", function () {
              if (pendingAgentChange) {
                HostBridge.postMessage({
                  type: "agentApprove",
                  changeId: pendingAgentChange.changeId,
                  action: "apply",
                });
                hideAgentChanges();
                setStatus("Applying changes...", "info", true);
              }
            });
          }

          if (rejectBtn) {
            rejectBtn.addEventListener("click", function () {
              if (pendingAgentChange) {
                HostBridge.postMessage({
                  type: "agentApprove",
                  changeId: pendingAgentChange.changeId,
                  action: "reject",
                });
                hideAgentChanges();
                setStatus("Changes rejected", "info", false);
              }
            });
          }

          if (viewDiffBtn) {
            viewDiffBtn.addEventListener("click", function () {
              if (pendingAgentChange) {
                HostBridge.postMessage({
                  type: "agentViewDiff",
                  changeId: pendingAgentChange.changeId,
                });
              }
            });
          }
        }

        function hideAgentChanges() {
          if (agentChangesContainer) {
            agentChangesContainer.style.display = "none";
            agentChangesContainer.innerHTML = "";
          }
          pendingAgentChange = null;
        }

        // CLI Commands Functions
        function showCliCommands(commands) {
          if (!commands || commands.length === 0) {
            hideCliCommands();
            return;
          }

          detectedCommands = commands;
          currentCommandIndex = 0;
          commandsExecuted = new Array(commands.length).fill(false);
          var cliContainer = document.getElementById("cliCommandsContainer");
          if (!cliContainer) return;

          renderCliCommands();
          cliContainer.style.display = "block";
        }

        function renderCliCommands() {
          var cliContainer = document.getElementById("cliCommandsContainer");
          if (!cliContainer) return;

          var html = '<div class="cli-commands-header">';
          html +=
            "<span>üîß Detected Commands (" +
            (currentCommandIndex + 1) +
            "/" +
            detectedCommands.length +
            ")</span>";
          html +=
            '<button id="dismissCli" style="background: transparent; border: none; cursor: pointer; font-size: 16px;">‚úï</button>';
          html += "</div>";

          // Run All / Run Next button
          if (currentCommandIndex === 0 && !commandsExecuted.some(Boolean)) {
            html += '<div style="margin-bottom: 8px;">';
            html +=
              '<button id="runAllCommands" class="btn-run-all" style="width: 100%; padding: 8px; border-radius: 4px;">‚ñ∂Ô∏è Run All Commands</button>';
            html += "</div>";
          } else if (currentCommandIndex < detectedCommands.length) {
            html += '<div style="margin-bottom: 8px;">';
            html +=
              '<button id="runNextCommand" class="btn-run-all" style="width: 100%; padding: 8px; border-radius: 4px;">‚ñ∂Ô∏è Run Next Command</button>';
            html += "</div>";
          }

          detectedCommands.forEach(function (cmd, index) {
            var itemClass = "cli-command-item";
            if (commandsExecuted[index]) {
              itemClass += " executed";
            } else if (index === currentCommandIndex) {
              itemClass += " current";
            }

            html +=
              '<div class="' + itemClass + '" data-cmd-index="' + index + '">';

            // Status indicator
            var statusIcon = "";
            if (commandsExecuted[index]) {
              statusIcon =
                '<span style="color: #4caf50; margin-right: 4px;">‚úì</span>';
            } else if (index === currentCommandIndex) {
              statusIcon =
                '<span style="color: #2196f3; margin-right: 4px;">‚Üí</span>';
            } else {
              statusIcon =
                '<span style="color: #999; margin-right: 4px;">' +
                (index + 1) +
                ".</span>";
            }

            html +=
              '<div class="cli-command-text">' +
              statusIcon +
              escapeHtmlBasic(cmd) +
              "</div>";
            html += '<div class="cli-command-actions">';
            html +=
              '<button class="btn-copy-command" data-cmd-index="' +
              index +
              '">üìã Copy</button>';

            if (!commandsExecuted[index]) {
              html +=
                '<button class="btn-run-command" data-cmd-index="' +
                index +
                '">‚ñ∂Ô∏è Run</button>';
            }

            html += "</div>";
            html += "</div>";
          });

          cliContainer.innerHTML = html;
          attachCliCommandHandlers();
        }

        function attachCliCommandHandlers() {
          var cliContainer = document.getElementById("cliCommandsContainer");

          // Dismiss button
          var dismissBtn = document.getElementById("dismissCli");
          if (dismissBtn) {
            dismissBtn.addEventListener("click", hideCliCommands);
          }

          // Run All button
          var runAllBtn = document.getElementById("runAllCommands");
          if (runAllBtn) {
            runAllBtn.addEventListener("click", function () {
              runNextCommand();
            });
          }

          // Run Next button
          var runNextBtn = document.getElementById("runNextCommand");
          if (runNextBtn) {
            runNextBtn.addEventListener("click", function () {
              runNextCommand();
            });
          }

          // Copy buttons
          var copyButtons = cliContainer.querySelectorAll(".btn-copy-command");
          copyButtons.forEach(function (btn) {
            btn.addEventListener("click", function () {
              var index = parseInt(btn.getAttribute("data-cmd-index"));
              var cmd = detectedCommands[index];
              if (cmd) {
                navigator.clipboard.writeText(cmd).then(function () {
                  var originalText = btn.textContent;
                  btn.textContent = "‚úì Copied";
                  setTimeout(function () {
                    btn.textContent = originalText;
                  }, 2000);
                });
              }
            });
          });

          // Individual run buttons
          var runButtons = cliContainer.querySelectorAll(".btn-run-command");
          runButtons.forEach(function (btn) {
            btn.addEventListener("click", function () {
              var index = parseInt(btn.getAttribute("data-cmd-index"));
              runCommand(index);
            });
          });
        }

        function runCommand(index, waitForCompletion) {
          if (index >= detectedCommands.length) return;

          var cmd = detectedCommands[index];
          if (cmd) {
            HostBridge.postMessage({
              type: "runCliCommand",
              command: cmd,
              commandIndex: index,
              waitForCompletion: waitForCompletion === true,
            });
          }
        }

        function runNextCommand() {
          if (currentCommandIndex < detectedCommands.length) {
            // Run with waitForCompletion=true for sequential execution
            runCommand(currentCommandIndex, true);
          }
        }

        function markCommandExecuted(index) {
          if (index >= 0 && index < detectedCommands.length) {
            commandsExecuted[index] = true;
            if (index === currentCommandIndex) {
              currentCommandIndex++;
            }
            renderCliCommands();
          }
        }

        function hideCliCommands() {
          var cliContainer = document.getElementById("cliCommandsContainer");
          if (cliContainer) {
            cliContainer.style.display = "none";
            cliContainer.innerHTML = "";
          }
          detectedCommands = [];
          currentCommandIndex = 0;
          commandsExecuted = [];
        }

        function escapeHtmlBasic(str) {
          if (!str) return "";
          return String(str)
            .replace(/&/g, "&amp;")
            .replace(/</g, "&lt;")
            .replace(/>/g, "&gt;")
            .replace(/"/g, "&quot;");
        }

        // File list render + interaction
        var currentFiles = [];
        var currentAttached = [];
        var dropdownRows = [];
        var dropdownSelected = -1;
        function renderFileList(files, attached) {
          try {
            if (!Array.isArray(files)) files = [];
            const attachedSet = new Set(attached || []);
            fileListRoot.innerHTML = "";
            // If we have no files but some attached entries, show attached ones
            if (
              (!files || files.length === 0) &&
              (!attached || attached.length === 0)
            ) {
              fileListRoot.textContent = "No workspace files found";
              return;
            }

            // normalize filter
            var filter = "";
            try {
              filter =
                fileSearch && fileSearch.value
                  ? String(fileSearch.value).toLowerCase().trim()
                  : "";
            } catch (e) {
              filter = "";
            }

            // If no filter, hide the results dropdown (do not show full list)
            if (!filter) {
              try {
                fileListRoot.innerHTML = "";
                fileListRoot.style.display = "none";
                if (fileHint) fileHint.style.display = "none";
              } catch (e) {}
              return;
            }

            // show the results container and keyboard hint
            try {
              fileListRoot.style.display = "block";
              if (fileHint) fileHint.style.display = "block";
            } catch (e) {}

            var visibleIndex = 0;
            dropdownRows = [];

            for (const f of files) {
              var nm = (f.name || f.path || "").toLowerCase();
              if (nm.indexOf(filter) === -1) continue;
              const row = document.createElement("div");
              row.style.display = "flex";
              row.style.alignItems = "center";
              row.style.justifyContent = "space-between";
              row.style.padding = "2px 4px";

              const left = document.createElement("div");
              left.style.display = "flex";
              left.style.alignItems = "center";

              const name = document.createElement("div");
              name.textContent = f.name || f.path;
              name.title = f.path;
              name.style.marginRight = "8px";

              const badge = document.createElement("div");
              badge.style.width = "18px";
              badge.style.height = "18px";
              badge.style.display = "inline-flex";
              badge.style.alignItems = "center";
              badge.style.justifyContent = "center";
              badge.style.cursor = "pointer";

              const isAttached = attachedSet.has(f.path);
              if (isAttached) {
                badge.textContent = "‚úî";
                badge.title = "Attached";
                badge.style.opacity = "0.9";
                badge.onclick = null;
              } else {
                badge.textContent = "+";
                badge.title = "Add to selection";
                badge.onclick = () => {
                  HostBridge.postMessage({ type: "attach", path: f.path });
                };
              }

              // Place the badge inline after the filename
              left.appendChild(name);
              left.appendChild(badge);
              row.appendChild(left);

              // accessibility / keyboard target
              row.className = "file-list-item";
              row.tabIndex = 0;
              row.dataset.index = String(visibleIndex);
              row.dataset.path = f.path;
              // mouse enter selects
              row.addEventListener("mouseenter", function () {
                setDropdownSelected(Number(row.dataset.index));
              });
              // click to attach (if not attached)
              row.addEventListener("click", function () {
                try {
                  if (!attachedSet.has(f.path)) {
                    HostBridge.postMessage({ type: "attach", path: f.path });
                    // hide dropdown and clear search for clarity
                    try {
                      if (fileListRoot) fileListRoot.style.display = "none";
                    } catch (_) {}
                  }
                } catch (e) {}
              });

              dropdownRows.push(row);
              visibleIndex++;

              fileListRoot.appendChild(row);
            }
            // ensure only up to N visible without scrolling (CSS handles scroll). nothing else to do here.
            if (dropdownSelected >= dropdownRows.length)
              dropdownSelected = dropdownRows.length - 1;
            updateDropdownFocus();
          } catch (e) {
            /* ignore rendering errors */
          }
        }

        function setDropdownSelected(idx) {
          try {
            dropdownSelected = typeof idx === "number" ? idx : -1;
            updateDropdownFocus();
          } catch (e) {}
        }

        function updateDropdownFocus() {
          try {
            for (var i = 0; i < dropdownRows.length; i++) {
              var r = dropdownRows[i];
              if (!r) continue;
              if (i === dropdownSelected) {
                r.classList.add("focused");
                try {
                  r.scrollIntoView({ block: "nearest" });
                } catch (e) {}
              } else {
                r.classList.remove("focused");
              }
            }
          } catch (e) {}
        }

        function renderAttachedPills(attached) {
          try {
            if (!activeFilesRoot) return;
            activeFilesRoot.innerHTML = "";
            if (!Array.isArray(attached) || attached.length === 0) return;
            for (const p of attached) {
              var base = p.split("/").pop();
              var pill = document.createElement("div");
              pill.style.display = "inline-flex";
              pill.style.alignItems = "center";
              pill.style.gap = "6px";
              pill.style.padding = "4px 8px";
              pill.style.borderRadius = "999px";
              pill.style.border = "1px solid var(--vscode-input-border)";
              pill.style.color = "var(--vscode-input-foreground)";
              pill.style.fontSize = "12px";

              var txt = document.createElement("span");
              txt.textContent = base || p;
              txt.title = p;
              pill.appendChild(txt);

              var rem = document.createElement("button");
              rem.textContent = "√ó";
              rem.title = "Remove attached file";
              rem.style.border = "none";
              rem.style.background = "transparent";
              rem.style.cursor = "pointer";
              rem.style.fontSize = "12px";
              rem.onclick = function () {
                HostBridge.postMessage({ type: "detach", path: p });
              };
              pill.appendChild(rem);

              activeFilesRoot.appendChild(pill);
            }
          } catch (e) {
            /* ignore */
          }
        }

        // request initial file list
        HostBridge.postMessage({ type: "requestFiles" });
        if (fileSearch) {
          fileSearch.addEventListener("input", function () {
            try {
              renderFileList(currentFiles, currentAttached);
            } catch (e) {}
          });
          // show results on focus as well if the field has content
          fileSearch.addEventListener("focus", function () {
            try {
              renderFileList(currentFiles, currentAttached);
            } catch (e) {}
          });
          // hide results if clicking outside (simple handler)
          document.addEventListener("click", function (ev) {
            try {
              var target = ev.target;
              if (!target) return;
              if (target === fileSearch) return;
              // if click inside the fileListRoot, ignore
              if (
                fileListRoot &&
                fileListRoot.contains &&
                fileListRoot.contains(target)
              )
                return;
              // otherwise hide dropdown
              if (fileListRoot) fileListRoot.style.display = "none";
              if (fileHint) fileHint.style.display = "none";
            } catch (e) {}
          });
        }
        // keyboard navigation for the dropdown
        if (fileSearch) {
          fileSearch.addEventListener("keydown", function (ev) {
            try {
              if (!dropdownRows || dropdownRows.length === 0) return;
              if (ev.key === "ArrowDown") {
                ev.preventDefault();
                dropdownSelected = Math.min(
                  dropdownSelected + 1 || 0,
                  dropdownRows.length - 1
                );
                updateDropdownFocus();
                return;
              }
              if (ev.key === "ArrowUp") {
                ev.preventDefault();
                dropdownSelected = Math.max(dropdownSelected - 1 || 0, 0);
                updateDropdownFocus();
                return;
              }
              if (ev.key === "Enter") {
                ev.preventDefault();
                if (
                  dropdownSelected >= 0 &&
                  dropdownSelected < dropdownRows.length
                ) {
                  var r = dropdownRows[dropdownSelected];
                  if (r && r.dataset && r.dataset.path) {
                    HostBridge.postMessage({
                      type: "attach",
                      path: r.dataset.path,
                    });
                    try {
                      if (fileListRoot) fileListRoot.style.display = "none";
                    } catch (_) {}
                  }
                }
                return;
              }
              if (ev.key === "Escape") {
                try {
                  if (fileListRoot) fileListRoot.style.display = "none";
                } catch (_) {}
                return;
              }
            } catch (e) {}
          });
        }

        var state = {
          isStreaming: false,
          queue: [],
          raf: null,
          totalChars: 0,
          maxChars: 50000,
          codeBlocks: [], // Store code blocks for copy/insert/apply actions
        };

        // ========= STATE PERSISTENCE =========
        function saveState() {
          try {
            var stateToSave = {
              conversationHistory: messages.innerHTML,
              currentMode: currentMode,
              currentSelection: currentSelection,
              detectedCommands: detectedCommands,
              currentCommandIndex: currentCommandIndex,
              commandsExecuted: commandsExecuted,
              codeBlocks: state.codeBlocks,
              timestamp: Date.now(),
            };

            console.log("üíæ Saving state:", {
              historyLength: stateToSave.conversationHistory.length,
              mode: stateToSave.currentMode,
              hasSelection: stateToSave.currentSelection.hasSelection,
              commandsCount: stateToSave.detectedCommands.length,
            });

            // Use VS Code API to persist state
            HostBridge.setState(stateToSave);
          } catch (e) {
            console.error("Failed to save state:", e);
          }
        }

        function loadState() {
          try {
            // Use VS Code API to retrieve state
            var parsed = HostBridge.getState();

            console.log(
              "üìÇ Loading state:",
              parsed
                ? {
                    historyLength: parsed.conversationHistory
                      ? parsed.conversationHistory.length
                      : 0,
                    mode: parsed.currentMode,
                    hasSelection: parsed.currentSelection
                      ? parsed.currentSelection.hasSelection
                      : false,
                    commandsCount: parsed.detectedCommands
                      ? parsed.detectedCommands.length
                      : 0,
                  }
                : "No saved state"
            );

            if (!parsed) return;

            // Check if state is not too old (24 hours)
            if (parsed.timestamp && Date.now() - parsed.timestamp > 86400000) {
              console.log("‚è∞ State expired, clearing");
              HostBridge.setState(null);
              return;
            }

            // Restore conversation history
            if (parsed.conversationHistory) {
              messages.innerHTML = parsed.conversationHistory;

              // Reattach event handlers for code blocks
              reattachCodeBlockHandlers();
            }

            // Restore mode
            if (parsed.currentMode) {
              setMode(parsed.currentMode);
            }

            // Restore selection
            if (
              parsed.currentSelection &&
              parsed.currentSelection.hasSelection
            ) {
              updateSelectionDisplay(parsed.currentSelection);
            }

            // Restore CLI commands
            if (parsed.detectedCommands && parsed.detectedCommands.length > 0) {
              detectedCommands = parsed.detectedCommands;
              currentCommandIndex = parsed.currentCommandIndex || 0;
              commandsExecuted = parsed.commandsExecuted || [];
              showCliCommands(detectedCommands);
            }

            // Restore code blocks
            if (parsed.codeBlocks) {
              console.log(
                "‚úÖ Restoring code blocks:",
                parsed.codeBlocks.length
              );
              state.codeBlocks = parsed.codeBlocks;
            }

            console.log("‚úÖ State restoration complete");
          } catch (e) {
            console.error("‚ùå Failed to load state:", e);
          }
        }

        function clearState() {
          try {
            HostBridge.setState(null);
          } catch (e) {
            console.error("Failed to clear state:", e);
          }
        }

        function reattachCodeBlockHandlers() {
          // Reattach copy buttons
          var copyButtons = messages.querySelectorAll(".code-copy-btn");
          copyButtons.forEach(function (btn) {
            btn.addEventListener("click", function (e) {
              e.stopPropagation();
              var codeBlock = btn.closest(".code-block");
              if (codeBlock) {
                var codeContent = codeBlock.querySelector("code");
                if (codeContent) {
                  var text = codeContent.textContent;
                  navigator.clipboard.writeText(text).then(function () {
                    btn.textContent = "‚úì";
                    setTimeout(function () {
                      btn.textContent = "Copy";
                    }, 2000);
                  });
                }
              }
            });
          });

          // Reattach other action buttons (insert, apply, diff)
          var actionButtons = messages.querySelectorAll(
            ".code-insert-btn, .code-apply-btn, .code-diff-btn"
          );
          actionButtons.forEach(function (btn) {
            btn.addEventListener("click", function (e) {
              e.stopPropagation();
              var action = btn.classList.contains("code-insert-btn")
                ? "insert"
                : btn.classList.contains("code-apply-btn")
                ? "apply"
                : "diff";
              var codeBlock = btn.closest(".code-block");
              if (codeBlock) {
                var codeContent = codeBlock.querySelector("code");
                if (codeContent) {
                  var code = codeContent.textContent;
                  var lang = codeContent.className.replace("language-", "");

                  if (action === "insert") {
                    HostBridge.postMessage({
                      type: "insertAtCursor",
                      code: code,
                      language: lang,
                    });
                  } else if (action === "apply") {
                    HostBridge.postMessage({
                      type: "applyCode",
                      code: code,
                      language: lang,
                    });
                  } else if (action === "diff") {
                    HostBridge.postMessage({
                      type: "showDiffAndApply",
                      code: code,
                      language: lang,
                    });
                  }
                }
              }
            });
          });
        }

        // Auto-save state periodically and on certain events
        setInterval(saveState, 5000); // Save every 5 seconds

        function flushQueue() {
          state.raf = null;
          while (state.queue.length) {
            var job = state.queue.shift();
            if (job) job();
          }
        }

        function enqueue(job) {
          state.queue.push(job);
          if (!state.raf) {
            state.raf = window.requestAnimationFrame(flushQueue);
          }
        }

        function trimOverflow() {
          while (state.totalChars > state.maxChars && messages.firstChild) {
            var first = messages.firstChild;
            var len = Number(
              first.dataset && first.dataset.textLength
                ? first.dataset.textLength
                : first.textContent.length
            );
            state.totalChars -= len;
            messages.removeChild(first);
          }
        }

        function escapeHtml(str) {
          if (str === void 0 || str === null) return "";
          return String(str)
            .replace(/&/g, "&amp;")
            .replace(/</g, "&lt;")
            .replace(/>/g, "&gt;");
        }

        // Inline code: text surrounded by grave accent (backtick), using \u0060 instead of literal backtick
        var inlineCodePattern = /\u0060([^\u0060]+)\u0060/g;

        function renderInline(line) {
          if (line === void 0 || line === null) line = "";
          var html = escapeHtml(line);
          html = html.replace(/\*\*(.+?)\*\*/g, "<strong>$1</strong>");
          html = html.replace(/\*(.+?)\*/g, "<em>$1</em>");
          html = html.replace(inlineCodePattern, "<code>$1</code>");
          return html;
        }

        // Code fences using three grave accents (no literal backtick in source, use \u0060)
        var fencePattern =
          /\u0060\u0060\u0060(\w+)?\n([\s\S]*?)\u0060\u0060\u0060/g;

        function renderMarkdown(source) {
          if (!source) return "";

          var codeBlocks = [];
          var fenced = source.replace(fencePattern, function (_m, lang, code) {
            var idx = codeBlocks.length;
            codeBlocks.push({ lang: lang || "", code: code || "" });
            return "\n{{CODE_BLOCK_" + idx + "}}\n";
          });

          // Store codeBlocks in state for action buttons
          state.codeBlocks = state.codeBlocks.concat(codeBlocks);

          var lines = fenced.replace(/\r\n/g, "\n").split("\n");
          var html = "";
          var inList = false;

          function closeList() {
            if (inList) {
              html += "</ul>";
              inList = false;
            }
          }

          for (var i = 0; i < lines.length; i++) {
            var rawLine = lines[i];

            if (rawLine.indexOf("{{CODE_BLOCK_") === 0) {
              closeList();
              var idxMatch = rawLine.match(/\d+/);
              var idx = idxMatch ? Number(idxMatch[0]) : 0;
              var block = codeBlocks[idx];
              var lang = block && block.lang ? block.lang : "";
              var code = escapeHtml(block && block.code ? block.code : "");
              var langClass = lang
                ? "language-" + lang.replace(/[^a-z0-9_-]/gi, "")
                : "language-plain";
              var langAttr = lang || "plain";
              // Wrap code block with action buttons
              html +=
                '<div class="code-block-wrapper" data-code-index="' +
                idx +
                '">';
              html += '<div class="code-block-actions">';
              html +=
                '<button class="code-copy-btn" title="Copy" data-code-index="' +
                idx +
                '"><svg viewBox="0 0 24 24"><path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/></svg></button>';
              html +=
                '<button class="code-insert-btn" title="Insert" data-code-index="' +
                idx +
                '"><svg viewBox="0 0 24 24"><path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/></svg></button>';
              html +=
                '<button class="code-apply-btn" title="Apply" data-code-index="' +
                idx +
                '"><svg viewBox="0 0 24 24"><path d="M9 16.2L4.8 12l-1.4 1.4L9 19 21 7l-1.4-1.4L9 16.2z"/></svg></button>';
              html +=
                '<button class="code-diff-btn" title="Diff" data-code-index="' +
                idx +
                '"><svg viewBox="0 0 24 24"><path d="M9 7H7v2h2V7zm0 4H7v2h2v-2zm0-8c-1.11 0-2 .9-2 2v2H5v2h2v2H5v2h2v2H5v2h2v2c0 1.1.89 2 2 2h10c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2H9zm10 16H9V5h10v14z"/></svg></button>';
              html += "</div>";
              html +=
                '<pre class="code-block" data-lang="' +
                langAttr +
                '"><code class="' +
                langClass +
                '">' +
                code +
                "</code></pre>";
              html += "</div>";
              continue;
            }

            // Bullet list (- item / * item)
            if (/^\s*[-*]\s+/.test(rawLine)) {
              var content = rawLine.replace(/^\s*[-*]\s+/, "");
              if (!inList) {
                html += '<ul class="message-list">';
                inList = true;
              }
              html += "<li>" + renderInline(content) + "</li>";
              continue;
            }

            closeList();

            if (rawLine.trim() === "") {
              html += "<br />";
              continue;
            }

            html += "<p>" + renderInline(rawLine) + "</p>";
          }

          closeList();
          return html;
        }

        function labelForRole(role) {
          switch (role) {
            case "user":
              return "You";
            case "assistant":
              return "Assistant";
            case "system":
              return "System";
            case "error":
              return "Error";
            default:
              return "Notice";
          }
        }

        function appendBlock(text, role) {
          if (role === void 0) role = "assistant";
          var safeText = text || "";
          enqueue(function () {
            // streaming: append to last assistant block if exists
            if (role === "assistant") {
              var last = messages.lastElementChild;
              if (last && last.classList.contains("assistant")) {
                var body = last.querySelector(".message-body");
                if (body) {
                  var prevRaw = last.dataset.rawText || "";
                  var nextRaw = prevRaw + safeText;
                  var prevLen = Number(last.dataset.textLength || "0");
                  var nextLen = nextRaw.length;
                  last.dataset.rawText = nextRaw;
                  last.dataset.textLength = String(nextLen);
                  state.totalChars += nextLen - prevLen;
                  body.innerHTML = renderMarkdown(nextRaw);
                  trimOverflow();
                  messages.scrollTop = messages.scrollHeight;
                  return;
                }
              }
            }

            var block = document.createElement("div");
            var roleClass =
              role === "error"
                ? "message error"
                : role === "user"
                ? "message user"
                : role === "system"
                ? "message system"
                : "message assistant";
            block.className = roleClass;

            var label = document.createElement("div");
            label.className = "message-label";
            label.textContent = labelForRole(role);
            block.appendChild(label);

            var bodyEl = document.createElement("div");
            bodyEl.className = "message-body";
            bodyEl.innerHTML = renderMarkdown(safeText);
            block.appendChild(bodyEl);

            // Add Replay / Copy buttons as a sibling element (outside the bubble)
            try {
              if (role === "user") {
                // after appending the message bubble we'll create a sibling div
                // create a factory for the actions so we can append after the bubble
                block._createActionsSibling = function () {
                  try {
                    var actionsDiv = document.createElement("div");
                    actionsDiv.className = "message-actions-sibling";

                    var replayBtn = document.createElement("button");
                    replayBtn.type = "button";
                    replayBtn.title = "Resend (reload) message";
                    replayBtn.setAttribute("aria-label", "Resend message");
                    // Reload/refresh style icon
                    replayBtn.innerHTML =
                      '<svg fill="#ffffff" width="800px" height="800px" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M23,12A11,11,0,1,1,12,1a10.9,10.9,0,0,1,5.882,1.7l1.411-1.411A1,1,0,0,1,21,2V6a1,1,0,0,1-1,1H16a1,1,0,0,1-.707-1.707L16.42,4.166A8.9,8.9,0,0,0,12,3a9,9,0,1,0,9,9,1,1,0,0,1,2,0Z"/></svg>';
                    replayBtn.onclick = function () {
                      try {
                        var raw = block.dataset.rawText || safeText || "";
                        HostBridge.postMessage({ type: "replay", prompt: raw });
                      } catch (e) {
                        console.error(e);
                      }
                    };

                    var copyBtn = document.createElement("button");
                    copyBtn.type = "button";
                    copyBtn.title = "Copy message to clipboard";
                    copyBtn.setAttribute("aria-label", "Copy message");
                    copyBtn.innerHTML =
                      '<svg viewBox="0 0 24 24" role="img" aria-hidden="true"><path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"></path></svg>';
                    copyBtn.onclick = function () {
                      try {
                        var txt = block.dataset.rawText || safeText || "";
                        // helper to toggle icon to tick and revert after delay
                        function showTickOnce(btn) {
                          try {
                            // clear existing timer if any
                            if (btn._copyTimer) {
                              clearTimeout(btn._copyTimer);
                              btn._copyTimer = null;
                            }
                            // store original icon markup to restore later
                            if (!btn._origIcon) btn._origIcon = btn.innerHTML;
                            btn.innerHTML =
                              '<svg viewBox="0 0 24 24" role="img" aria-hidden="true"><path d="M9 16.2l-3.5-3.5L4 14.2 9 19.2 20 8.2 18.6 6.8z"></path></svg>';
                            btn.title = "Copied";
                            btn.setAttribute("aria-label", "Copied");
                            // revert after 5s
                            btn._copyTimer = setTimeout(function () {
                              try {
                                btn.innerHTML = btn._origIcon || "";
                                btn.title = "Copy message to clipboard";
                                btn.setAttribute("aria-label", "Copy message");
                              } catch (e) {}
                              btn._copyTimer = null;
                            }, 5000);
                          } catch (e) {}
                        }

                        if (
                          navigator &&
                          navigator.clipboard &&
                          typeof navigator.clipboard.writeText === "function"
                        ) {
                          navigator.clipboard
                            .writeText(txt)
                            .then(function () {
                              setStatus("Copied to clipboard", "info", false);
                              showTickOnce(copyBtn);
                            })
                            .catch(function (err) {
                              console.error("copy failed", err);
                              setStatus("Copy failed", "error", false);
                            });
                        } else {
                          var ta = document.createElement("textarea");
                          ta.value = txt;
                          document.body.appendChild(ta);
                          ta.select();
                          try {
                            var ok = document.execCommand("copy");
                            document.body.removeChild(ta);
                            if (ok) {
                              setStatus("Copied to clipboard", "info", false);
                              showTickOnce(copyBtn);
                            } else {
                              setStatus("Copy failed", "error", false);
                            }
                          } catch (e) {
                            document.body.removeChild(ta);
                            console.error("clipboard fallback failed", e);
                            setStatus("Copy failed", "error", false);
                          }
                        }
                      } catch (e) {
                        console.error(e);
                        setStatus("Copy failed", "error", false);
                      }
                    };

                    actionsDiv.appendChild(replayBtn);
                    actionsDiv.appendChild(copyBtn);
                    return actionsDiv;
                  } catch (e) {
                    return null;
                  }
                };
              }
            } catch (e) {
              /* ignore action wiring errors */
            }

            block.dataset.rawText = safeText;
            block.dataset.textLength = String(safeText.length);
            messages.appendChild(block);
            // If an actions sibling factory was attached, create and append the sibling
            try {
              if (typeof block._createActionsSibling === "function") {
                var sibling = block._createActionsSibling();
                if (sibling) messages.appendChild(sibling);
              }
            } catch (e) {
              /* ignore sibling append errors */
            }
            // Append a thin separator after assistant messages only
            try {
              if (role === "assistant") {
                var sepAfter = document.createElement("div");
                sepAfter.className = "message-separator";
                sepAfter.setAttribute("aria-hidden", "true");
                messages.appendChild(sepAfter);
              }
            } catch (e) {}
            state.totalChars += safeText.length;
            trimOverflow();
            messages.scrollTop = messages.scrollHeight;
          });
        }

        function clearMessages() {
          enqueue(function () {
            messages.textContent = "";
            state.totalChars = 0;
            state.codeBlocks = [];

            // Notify backend to clear conversation history
            HostBridge.postMessage({ type: "clearHistory" });

            // Also clear persisted state
            clearState();
          });
        }

        function setStatus(text, level, streaming) {
          if (level === void 0) level = "info";
          if (streaming === void 0) streaming = false;
          statusText.textContent = text;
          statusRoot.dataset.level = level;
          state.isStreaming = streaming;
          spinner.hidden = !streaming;
          updateSendState();
        }

        function updateSendState() {
          var hasText = promptInput.value.trim().length > 0;
          sendBtn.disabled = state.isStreaming || !hasText;
        }

        function sendPrompt() {
          var value = promptInput.value.trim();
          if (!value || state.isStreaming) return;

          // Different status message based on mode
          if (currentMode === "agent") {
            setStatus("ü§ñ Agent processing‚Ä¶", "info", true);
          } else {
            setStatus("Sending prompt‚Ä¶", "info", true);
          }

          // Build the prompt with selection context if available
          var fullPrompt = value;
          var displayPrompt = value;

          if (currentSelection.hasSelection && currentSelection.selectedText) {
            // Include selection context in the prompt
            var selectionHeader =
              "--- SELECTED CODE (" +
              currentSelection.fileName +
              ", " +
              (currentSelection.startLine === currentSelection.endLine
                ? "line " + currentSelection.startLine
                : "lines " +
                  currentSelection.startLine +
                  "-" +
                  currentSelection.endLine) +
              ") ---\n";
            var selectionFooter = "\n--- END SELECTED CODE ---\n\n";
            fullPrompt =
              selectionHeader +
              currentSelection.selectedText +
              selectionFooter +
              value;
            displayPrompt =
              (currentMode === "agent" ? "ü§ñ " : "üìù ") +
              "[" +
              currentSelection.fileName +
              " L" +
              currentSelection.startLine +
              (currentSelection.startLine !== currentSelection.endLine
                ? "-" + currentSelection.endLine
                : "") +
              "]\n" +
              value;
          } else if (currentMode === "agent") {
            displayPrompt = "ü§ñ " + value;
          }

          appendBlock(displayPrompt, "user");

          // Send with mode information
          HostBridge.postMessage({
            type: "send",
            prompt: fullPrompt,
            mode: currentMode,
            selection: currentSelection.hasSelection ? currentSelection : null,
          });

          promptInput.value = "";

          // Optionally clear selection after sending
          // clearSelection();

          updateSendState();
        }

        promptInput.addEventListener("input", updateSendState);
        promptInput.addEventListener("keydown", function (event) {
          if ((event.metaKey || event.ctrlKey) && event.key === "Enter") {
            event.preventDefault();
            sendPrompt();
          }
        });

        sendBtn.addEventListener("click", sendPrompt);

        if (clearHistoryBtn) {
          clearHistoryBtn.addEventListener("click", function () {
            if (confirm("Are you sure you want to clear the chat history?")) {
              clearMessages();
            }
          });
        }

        // Code block action button handlers (event delegation)
        messages.addEventListener("click", function (event) {
          var target = event.target;
          // Find button even if clicked on SVG/path
          while (
            target &&
            target !== messages &&
            !target.classList.contains("code-copy-btn") &&
            !target.classList.contains("code-insert-btn") &&
            !target.classList.contains("code-apply-btn") &&
            !target.classList.contains("code-diff-btn")
          ) {
            target = target.parentElement;
          }
          if (!target || target === messages) return;

          // Find the code block wrapper to get the raw code
          var wrapper = target.closest(".code-block-wrapper");
          if (!wrapper) return;

          var codeEl = wrapper.querySelector("code");
          if (!codeEl) return;

          // Get raw code (unescape HTML entities)
          var rawCode = codeEl.textContent || "";

          if (target.classList.contains("code-copy-btn")) {
            // Copy to clipboard
            HostBridge.postMessage({ type: "copyCode", code: rawCode });
            setStatus("Copied to clipboard!", "info", false);
          } else if (target.classList.contains("code-insert-btn")) {
            // Insert at cursor
            HostBridge.postMessage({ type: "insertAtCursor", code: rawCode });
            setStatus("Inserting code...", "info", false);
          } else if (target.classList.contains("code-apply-btn")) {
            // Apply (replace selection or file)
            HostBridge.postMessage({
              type: "applyCode",
              code: rawCode,
              replaceSelection: true,
            });
            setStatus("Applying code...", "info", false);
          } else if (target.classList.contains("code-diff-btn")) {
            // Show diff
            HostBridge.postMessage({ type: "showDiffAndApply", code: rawCode });
            setStatus("Opening diff view...", "info", false);
          }
        });

        // Use HostBridge to receive messages from either host (VS Code or WebView2)
        HostBridge.onMessage(function (msg) {
          if (!msg) return;
          switch (msg.type) {
            case "append":
              appendBlock(msg.text, msg.role || "assistant");
              break;
            case "fileList":
              try {
                currentFiles = msg.files || [];
                renderFileList(currentFiles, currentAttached);
                renderAttachedPills(currentAttached);
              } catch (e) {
                /* ignore */
              }
              break;
            case "attachedChanged":
              try {
                currentAttached = msg.files || [];
                renderFileList(currentFiles, currentAttached);
                renderAttachedPills(currentAttached);
              } catch (e) {
                /* ignore */
              }
              break;
            case "editor":
              setEditorLabel(msg.text || "");
              break;
            case "selectionChanged":
              updateSelectionDisplay(msg);
              break;
            case "agentPendingChange":
              // Agent mode: show pending change for approval
              showAgentChanges(msg);
              break;
            case "agentChangeApplied":
              // Agent successfully applied changes
              hideAgentChanges();
              appendBlock(
                "‚úÖ Changes applied to " + (msg.fileName || "file"),
                "system"
              );
              break;
            case "agentChangeRejected":
              // User rejected the change
              hideAgentChanges();
              break;
            case "cliCommandsDetected":
              // Show detected CLI commands
              showCliCommands(msg.commands || []);
              break;
            case "cliCommandResult":
              // Immediate command result (without waiting for completion)
              var cmdIndex =
                msg.commandIndex !== undefined ? msg.commandIndex : -1;
              if (msg.success) {
                appendBlock(
                  "‚ñ∂Ô∏è Running command " +
                    (cmdIndex + 1) +
                    ": " +
                    (msg.command || ""),
                  "system"
                );
              } else {
                appendBlock(
                  "‚ùå Command failed to start: " +
                    (msg.error || "Unknown error"),
                  "error"
                );
              }
              break;
            case "cliCommandCompleted":
              // Command completed (with waitForCompletion)
              var cmdIndex =
                msg.commandIndex !== undefined ? msg.commandIndex : -1;

              if (msg.success) {
                if (cmdIndex >= 0) {
                  markCommandExecuted(cmdIndex);
                }
                appendBlock(
                  "‚úÖ Command " +
                    (cmdIndex + 1) +
                    " completed: " +
                    (msg.command || ""),
                  "system"
                );

                // Auto-run next command in sequence
                if (cmdIndex >= 0 && cmdIndex === currentCommandIndex - 1) {
                  if (currentCommandIndex < detectedCommands.length) {
                    // Small delay before next command
                    setTimeout(function () {
                      runNextCommand();
                    }, 500);
                  } else {
                    appendBlock("‚úÖ All commands completed!", "system");
                  }
                }
              } else {
                appendBlock(
                  "‚ùå Command " +
                    (cmdIndex + 1) +
                    " failed: " +
                    (msg.error || "Unknown error"),
                  "error"
                );
                // Stop auto-execution on error
              }
              break;
            case "clear":
              clearMessages();
              break;
            case "error":
              appendBlock(msg.text || "Unknown error", "error");
              setStatus(msg.text || "Error", "error", false);
              hideAgentChanges();
              break;
            case "status":
              setStatus(
                msg.text || "Idle",
                msg.level || "info",
                !!msg.streaming
              );
              break;
          }
        });

        setStatus("Idle", "info", false);
        updateSendState();

        // Load saved state on initialization
        console.log("üöÄ Initializing, attempting to load state...");
        loadState();

        // Save state when user is about to leave
        window.addEventListener("beforeunload", function () {
          console.log("üëã Page unloading, saving state...");
          saveState();
        });
      })();
    </script>
  </body>
</html>
