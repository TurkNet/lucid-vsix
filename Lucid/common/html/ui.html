<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Lucid Chat</title>
  <style nonce="__NONCE__">
    :root { color-scheme: light dark; }
    * { box-sizing: border-box; }
    html, body {
      height: 100%;
    }
    body {
      margin: 0;
      padding: 12px;
      background: var(--vscode-sideBar-background);
      color: var(--vscode-foreground);
      font-family: var(--vscode-font-family, -apple-system, BlinkMacSystemFont, sans-serif);
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }
    .shell {
      display: flex;
      flex-direction: column;
      gap: 10px;
      flex: 1;
      min-height: 0;
    }
    .messages {
      flex: 1;
      overflow-y: auto;
      padding: 12px;
      border: 1px solid var(--vscode-panel-border);
      border-radius: 6px;
      background: var(--vscode-editor-background);
      box-shadow: inset 0 0 0 1px rgba(255, 255, 255, 0.03);
      display: flex;
      flex-direction: column;
      gap: 8px;
      min-height: 0;
    }
    .composer {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    .message {
      display: inline-flex;
      flex-direction: column;
      gap: 6px;
      margin: 0;
      padding: 10px 12px;
      border-radius: 8px;
      background: rgba(255, 255, 255, 0.02);
      align-self: flex-start;
      text-align: left;
      max-width: 100%;
      box-shadow: 0 1px 2px rgba(0,0,0,0.15);
    }
    .message.assistant {
      background: rgba(255, 255, 255, 0.02);
    }
    .message.user {
      background: rgba(0, 120, 212, 0.18);
      color: var(--vscode-foreground);
      align-self: flex-end;
      text-align: right;
    }
    .message.system {
      border: 1px dashed var(--vscode-descriptionForeground);
      background: transparent;
      color: var(--vscode-descriptionForeground);
    }
    .message.error {
      border: 1px solid var(--vscode-errorForeground);
      color: var(--vscode-errorForeground);
      background: transparent;
    }
    .message-label {
      font-size: 10px;
      text-transform: uppercase;
      letter-spacing: 0.06em;
      opacity: 0.7;
    }
    .message.user .message-label {
      align-self: flex-end;
    }
    .message-body {
      margin: 0;
      padding: 0;
      background: transparent;
      border: none;
      white-space: normal;
      font-family: var(--vscode-editor-font-family, Menlo, Monaco, "Courier New", monospace);
      font-size: 13px;
      line-height: 1.4;
    }
    .message-body code {
      font-size: 12px;
      padding: 0 4px;
      border-radius: 4px;
      background: rgba(249, 245, 255, 0.1);
    }
    .message-body .code-block {
      margin: 10px 0;
      padding: 12px;
      border-radius: 6px;
      background: rgba(249, 245, 255, 0.05);
      border: 1px solid rgba(255,255,255,0.08);
      overflow-x: auto;
      font-family: var(--vscode-editor-font-family, Menlo, Monaco, "Courier New", monospace);
      font-size: 12px;
      line-height: 1.6;
      position: relative;
      white-space: pre-wrap;
    }
    .message-body .code-block::before {
      content: attr(data-lang);
      position: absolute;
      top: 6px;
      right: 8px;
      font-size: 10px;
      letter-spacing: 0.04em;
      text-transform: uppercase;
      color: var(--vscode-descriptionForeground);
    }
    textarea {
      resize: vertical;
      border-radius: 6px;
      padding: 8px;
      border: 1px solid var(--vscode-input-border, transparent);
      background: var(--vscode-input-background);
      color: var(--vscode-input-foreground);
      font-family: var(--vscode-editor-font-family, Menlo, Monaco, "Courier New", monospace);
      min-height: 80px;
      max-height: 160px;
    }
    .controls {
      display: flex;
      align-items: center;
      flex-wrap: wrap;
      gap: 10px;
    }
    .mode-select {
      min-width: 120px;
      padding: 6px 10px;
      border-radius: 4px;
      border: 1px solid var(--vscode-input-border, transparent);
      background: var(--vscode-input-background);
      color: var(--vscode-input-foreground);
      font-size: 12px;
    }
    .status {
      display: flex;
      align-items: center;
      gap: 6px;
      color: var(--vscode-descriptionForeground);
      flex: 1;
      min-width: 160px;
    }
    .status[data-level="error"] {
      color: var(--vscode-errorForeground);
    }
    .spinner {
      width: 12px;
      height: 12px;
      border: 2px solid transparent;
      border-top-color: var(--vscode-progressBar-background);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
    button {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      border: none;
      border-radius: 4px;
      padding: 6px 14px;
      font-size: 12px;
      cursor: pointer;
      background: var(--vscode-button-secondaryBackground);
      color: var(--vscode-button-secondaryForeground);
    }
    button.primary {
      background: var(--vscode-button-background);
      color: var(--vscode-button-foreground);
    }
    button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }
    .message-action {
      border: 1px solid rgba(0,0,0,0.2);
    }
    .action-preview-card {
      margin-top: 10px;
      border-radius: 8px;
      border: 1px solid rgba(255,255,255,0.08);
      background: rgba(0,0,0,0.15);
      padding: 10px;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    .auto-edit-review {
      margin-top: 10px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,0.08);
      background: rgba(15, 20, 29, 0.9);
      padding: 12px;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    .auto-edit-review[data-state="kept"] {
      border-color: rgba(63, 207, 142, 0.5);
    }
    .auto-edit-review[data-state="undone"] {
      border-color: rgba(255, 105, 97, 0.4);
    }
    .auto-edit-head {
      display: flex;
      gap: 8px;
      align-items: center;
      flex-wrap: wrap;
    }
    .auto-edit-summary {
      flex: 1;
      min-width: 160px;
      display: flex;
      flex-direction: column;
      gap: 2px;
    }
    .auto-edit-summary-title {
      font-size: 13px;
      font-weight: 600;
    }
    .auto-edit-summary-desc {
      font-size: 11px;
      color: var(--vscode-descriptionForeground);
    }
    .auto-edit-actions {
      display: inline-flex;
      gap: 6px;
      flex-wrap: wrap;
    }
    .auto-edit-actions button {
      border-radius: 999px;
      font-size: 12px;
      padding: 4px 10px;
    }
    .auto-edit-actions button.undo {
      background: rgba(255, 105, 97, 0.15);
      color: #ff8780;
    }
    .auto-edit-file {
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 12px;
      padding: 8px 10px;
      border-radius: 8px;
      background: rgba(0,0,0,0.25);
    }
    .auto-edit-file-path {
      flex: 1;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      font-weight: 600;
    }
    .auto-edit-file-stats {
      display: inline-flex;
      gap: 8px;
      font-weight: 600;
    }
    .auto-edit-file-stats .added {
      color: #3fcf8e;
    }
    .auto-edit-file-stats .removed {
      color: #ff6961;
    }
    .auto-edit-review-status {
      font-size: 11px;
      color: var(--vscode-descriptionForeground);
    }
    .diff-view {
      margin: 0;
      background: rgba(0,0,0,0.35);
      border-radius: 10px;
      padding: 12px;
      overflow: auto;
      font-family: var(--vscode-editor-font-family, monospace);
      font-size: 12px;
      line-height: 1.4;
      white-space: pre-wrap;
    }
    .diff-line {
      display: block;
      padding: 2px 6px;
      border-radius: 4px;
    }
    .diff-line + .diff-line {
      margin-top: 2px;
    }
    .diff-line.add {
      background: rgba(63, 207, 142, 0.25);
    }
    .diff-line.remove {
      background: rgba(255, 105, 97, 0.25);
    }
    .diff-line.meta {
      color: var(--vscode-descriptionForeground);
    }
    .auto-edit-review-actions {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }
    .auto-edit-review-actions button {
      flex: 1;
      justify-content: center;
    }
    .auto-edit-review-actions button.undo {
      background: var(--vscode-errorForeground);
      color: #000;
    }
    .auto-edit-review-status {
      font-size: 11px;
      color: var(--vscode-descriptionForeground);
    }
    .action-output {
      margin-top: 10px;
      border-radius: 10px;
      border: 1px solid rgba(255,255,255,0.08);
      background: linear-gradient(135deg, rgba(20,20,20,0.95), rgba(15,28,46,0.85));
      overflow: hidden;
      transition: border-color 0.2s ease, box-shadow 0.2s ease;
    }
    .action-output.success {
      border-color: rgba(63, 207, 142, 0.5);
      box-shadow: 0 0 0 1px rgba(63, 207, 142, 0.15);
    }
    .action-output.error {
      border-color: rgba(255, 105, 97, 0.5);
      box-shadow: 0 0 0 1px rgba(255, 105, 97, 0.12);
    }
    .action-output-toggle {
      width: 100%;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 10px 12px;
      background: transparent;
      border: none;
      color: inherit;
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
    }
    .action-output-heading {
      display: flex;
      flex-direction: column;
      gap: 2px;
      flex: 1;
      min-width: 0;
      text-align: left;
    }
    .action-output-toggle:focus-visible {
      outline: 1px solid var(--vscode-focusBorder, rgba(255,255,255,0.5));
      outline-offset: -3px;
    }
    .action-output-title {
      font-size: 12px;
      letter-spacing: 0.02em;
      text-transform: uppercase;
    }
    .action-output-command {
      display: block;
      font-size: 11px;
      color: rgba(255,255,255,0.8);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      width: 100%;
    }
    .action-output-status {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }
    .action-output-status.error {
      color: var(--vscode-errorForeground);
    }
    .action-output-status.ok {
      color: var(--vscode-testing-iconPassed, #3fcf8e);
    }
    .action-output-icon {
      display: inline-flex;
      transform: rotate(0deg);
      transition: transform 0.2s ease;
    }
    .action-output.open .action-output-icon {
      transform: rotate(90deg);
    }
    .action-output-body {
      border-top: 1px solid rgba(255,255,255,0.08);
      padding: 12px;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    .action-output-body[hidden] {
      display: none;
    }
    .action-output-meta {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
      gap: 8px;
      font-size: 11px;
      color: var(--vscode-descriptionForeground);
    }
    .action-output-meta strong {
      display: block;
      font-size: 10px;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      margin-bottom: 2px;
    }
    .action-output-section {
      border: 1px solid rgba(255,255,255,0.08);
      border-radius: 8px;
      background: rgba(0,0,0,0.25);
      overflow: hidden;
    }
    .action-output-section-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 6px 10px;
      font-size: 11px;
      letter-spacing: 0.04em;
      text-transform: uppercase;
      border-bottom: 1px solid rgba(255,255,255,0.08);
    }
    .action-output-section-header button {
      font-size: 10px;
      padding: 4px 8px;
    }
    .action-output-section pre {
      margin: 0;
      padding: 10px;
      max-height: 240px;
      overflow-y: auto;
      font-size: 12px;
      white-space: pre-wrap;
    }
    .action-output-suggestions {
      border: 1px dashed rgba(255,255,255,0.2);
      border-radius: 8px;
      padding: 10px 12px;
    }
    .action-output-suggestions strong {
      font-size: 10px;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      display: block;
      margin-bottom: 4px;
    }
    .action-output-suggestions ul {
      margin: 0;
      padding-left: 16px;
      font-size: 12px;
    }
    .action-output-empty {
      font-size: 12px;
      color: var(--vscode-descriptionForeground);
      opacity: 0.9;
    }
    .todo-card {
      margin-top: 12px;
      border-radius: 10px;
      border: 1px solid rgba(255,255,255,0.07);
      background: rgba(12,18,28,0.85);
      padding: 12px;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    .todo-card-header {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }
    .todo-card-title {
      font-size: 12px;
      letter-spacing: 0.08em;
      text-transform: uppercase;
    }
    .todo-card-desc {
      font-size: 12px;
      color: var(--vscode-descriptionForeground);
    }
    .todo-list {
      list-style: none;
      margin: 0;
      padding: 0;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    .todo-item {
      display: flex;
      flex-direction: column;
      gap: 8px;
      padding: 10px;
      border-radius: 8px;
      background: rgba(255,255,255,0.02);
      border: 1px solid rgba(255,255,255,0.05);
    }
    .todo-item-main {
      display: flex;
      align-items: flex-start;
      gap: 8px;
    }
    .todo-item-index {
      font-size: 11px;
      opacity: 0.7;
    }
    .todo-item-title {
      font-size: 13px;
      font-weight: 600;
    }
    .todo-item-detail {
      font-size: 12px;
      color: var(--vscode-descriptionForeground);
      margin-left: 26px;
      margin-top: 4px;
    }
    .todo-item-actions {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
    }
    .todo-item-snippet {
      margin: 0;
      padding: 6px 8px;
      background: rgba(0,0,0,0.35);
      border-radius: 6px;
      font-size: 12px;
      white-space: pre-wrap;
      flex: 1;
      min-width: 160px;
    }
    .todo-item button {
      align-self: flex-start;
    }
    .workflow-card {
      margin-top: 12px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,0.08);
      background: rgba(8,12,18,0.92);
      padding: 14px;
      display: flex;
      flex-direction: column;
      gap: 14px;
    }
    .workflow-section {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    .workflow-section-title {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--vscode-descriptionForeground);
    }
    .workflow-files {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 8px;
    }
    .workflow-file {
      border: 1px solid rgba(255,255,255,0.07);
      border-radius: 8px;
      padding: 10px;
      display: flex;
      flex-direction: column;
      gap: 6px;
      background: rgba(255,255,255,0.02);
    }
    .workflow-file-path {
      font-size: 12px;
      font-weight: 600;
      word-break: break-word;
    }
    .workflow-file-summary {
      font-size: 12px;
      color: var(--vscode-descriptionForeground);
    }
    .workflow-badge {
      font-size: 10px;
      padding: 2px 6px;
      border-radius: 999px;
      align-self: flex-start;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      border: 1px solid rgba(255,255,255,0.08);
    }
    .workflow-badge[data-status="changed"], .workflow-test-status[data-status="passed"] {
      color: #3fcf8e;
      border-color: rgba(63,207,142,0.4);
    }
    .workflow-badge[data-status="scanned"], .workflow-test-status[data-status="running"] {
      color: #f4d35e;
      border-color: rgba(244,211,94,0.4);
    }
    .workflow-badge[data-status="error"], .workflow-test-status[data-status="failed"] {
      color: var(--vscode-errorForeground);
      border-color: rgba(255,105,97,0.5);
    }
    .workflow-diff-state {
      display: inline-flex;
      align-items: center;
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.03em;
      background: rgba(255,255,255,0.08);
    }
    .workflow-diff-state.keep {
      background: rgba(63, 207, 142, 0.2);
      color: #3fcf8e;
    }
    .workflow-diff-state.undo {
      background: rgba(255, 105, 97, 0.2);
      color: #ff6961;
    }
    .workflow-diff {
      border: 1px solid rgba(255,255,255,0.08);
      border-radius: 10px;
      overflow: hidden;
    }
    .workflow-diff.focused {
      box-shadow: 0 0 0 2px rgba(63,207,142,0.35);
    }
    .workflow-diff-header {
      display: flex;
      justify-content: space-between;
      gap: 8px;
      padding: 8px 10px;
      background: rgba(0,0,0,0.3);
      font-weight: 600;
    }
    .workflow-diff-actions {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
    }
    .workflow-diff-body {
      padding: 10px;
      background: rgba(0,0,0,0.35);
    }
    .workflow-diff-body .diff-view {
      margin: 0;
      max-height: 220px;
      overflow: auto;
      white-space: pre-wrap;
      font-size: 12px;
    }
    .workflow-diff-meta {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 11px;
      margin-bottom: 6px;
      gap: 10px;
    }
    .workflow-diff-file {
      flex: 1;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      font-weight: 600;
    }
    .workflow-diff-stats {
      display: inline-flex;
      gap: 6px;
      font-weight: 600;
    }
    .workflow-diff-stats .added {
      color: #3fcf8e;
    }
    .workflow-diff-stats .removed {
      color: #ff6961;
    }
    .workflow-patches,
    .workflow-tests {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    .workflow-patch {
      border: 1px solid rgba(255,255,255,0.05);
      border-radius: 8px;
      padding: 10px;
      display: flex;
      justify-content: space-between;
      gap: 10px;
      align-items: center;
    }
    .workflow-patch-info {
      display: flex;
      flex-direction: column;
      gap: 4px;
      font-size: 12px;
    }
    .workflow-tests-row {
      border: 1px solid rgba(255,255,255,0.05);
      border-radius: 8px;
      padding: 10px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
    }
    .workflow-test-name {
      font-size: 12px;
      font-weight: 600;
    }
    .workflow-test-status {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.08em;
    }
    .workflow-report {
      border: 1px solid rgba(255,255,255,0.05);
      border-radius: 10px;
      padding: 12px;
      display: flex;
      flex-direction: column;
      gap: 10px;
      background: rgba(0,0,0,0.25);
    }
    .workflow-report-title {
      font-size: 13px;
      font-weight: 600;
    }
    .workflow-report-highlights {
      margin: 0;
      padding-left: 18px;
      color: var(--vscode-descriptionForeground);
      font-size: 12px;
    }
    .workflow-metrics {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
      gap: 10px;
    }
    .workflow-metric {
      border: 1px solid rgba(255,255,255,0.06);
      border-radius: 8px;
      padding: 8px;
      text-align: center;
    }
    .workflow-metric-label {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.06em;
      color: var(--vscode-descriptionForeground);
    }
    .workflow-metric-value {
      font-size: 14px;
      font-weight: 600;
    }
    .workflow-artifacts {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }
    .workflow-empty {
      font-size: 12px;
      color: var(--vscode-descriptionForeground);
    }
    .action-preview-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
    }
    .action-preview-header-actions {
      display: inline-flex;
      gap: 4px;
      margin-left: auto;
    }
    .action-preview-icon-btn {
      width: 28px;
      height: 26px;
      padding: 0;
      border-radius: 4px;
      border: 1px solid rgba(255,255,255,0.12);
      background: rgba(0,0,0,0.2);
      display: inline-flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      color: var(--vscode-foreground);
    }
    .action-preview-icon-btn svg {
      width: 14px;
      height: 14px;
      fill: currentColor;
    }
    .action-preview-icon-btn:disabled {
      opacity: 0.4;
      cursor: not-allowed;
    }
    .action-preview-type {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.06em;
      color: var(--vscode-descriptionForeground);
    }
    .action-preview-code {
      margin: 0;
      padding: 10px;
      border-radius: 6px;
      background: rgba(0,0,0,0.35);
      border: 1px solid rgba(255,255,255,0.1);
      font-family: var(--vscode-editor-font-family, Menlo, Monaco, "Courier New", monospace);
      font-size: 12px;
      overflow-x: auto;
      white-space: pre-wrap;
    }
    .action-code-toolbar {
      display: flex;
      justify-content: flex-end;
      gap: 6px;
      margin-top: 6px;
      flex-wrap: wrap;
    }
    .action-code-toolbar button {
      border: 1px solid rgba(255,255,255,0.12);
      background: rgba(0,0,0,0.2);
      color: var(--vscode-foreground);
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 11px;
      display: inline-flex;
      align-items: center;
      gap: 4px;
      cursor: pointer;
    }
    .action-code-toolbar button:hover {
      background: rgba(255,255,255,0.08);
    }
    .action-code-toolbar button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    .action-code-toolbar button.action-primary {
      background: var(--vscode-button-background);
      border-color: transparent;
      color: var(--vscode-button-foreground);
    }
    .action-toolbar-icon {
      width: 14px;
      height: 14px;
      fill: currentColor;
    }
    .action-toolbar-more {
      position: relative;
    }
    .action-toolbar-more-menu {
      position: absolute;
      right: 0;
      top: calc(100% + 4px);
      background: var(--vscode-editor-background);
      border: 1px solid rgba(255,255,255,0.15);
      border-radius: 6px;
      box-shadow: 0 6px 16px rgba(0,0,0,0.35);
      min-width: 180px;
      display: none;
      z-index: 10;
    }
    .action-toolbar-more.open .action-toolbar-more-menu {
      display: block;
    }
    .action-toolbar-more-menu button {
      width: 100%;
      padding: 6px 10px;
      border: none;
      background: transparent;
      text-align: left;
      font-size: 12px;
    }
    .action-toolbar-more-menu button:hover {
      background: rgba(255,255,255,0.05);
    }
    .action-json-block {
      margin-top: 6px;
      padding: 8px;
      border-radius: 6px;
      background: rgba(0,0,0,0.25);
      border: 1px dashed rgba(255,255,255,0.1);
      font-family: var(--vscode-editor-font-family, Menlo, Monaco, "Courier New", monospace);
      font-size: 11px;
      white-space: pre-wrap;
      max-height: 200px;
      overflow: auto;
    }
    .action-preview-desc {
      font-size: 12px;
      color: var(--vscode-descriptionForeground);
    }
    .icon-plane {
      width: 14px;
      height: 14px;
      fill: currentColor;
      flex-shrink: 0;
    }
    /* File search dropdown / list styles to match VS Code look */
    #fileList { box-shadow: var(--vscode-widget-shadow, 0 1px 0 rgba(0,0,0,0.1)); border-radius: 6px; }
    .file-list-item { padding: 6px 8px; border-radius: 4px; cursor: pointer; display: flex; align-items: center; justify-content: space-between; gap: 8px; color: var(--vscode-foreground); }
    .file-list-item:hover { background: var(--vscode-list-hoverBackground); color: var(--vscode-list-hoverForeground); }
    .file-list-item.focused { background: var(--vscode-list-activeSelectionBackground); color: var(--vscode-list-activeSelectionForeground); outline: none; }
    #fileList::-webkit-scrollbar { height: 8px; width: 8px; }
    #fileList::-webkit-scrollbar-thumb { background: rgba(128,128,128,0.25); border-radius: 4px; }
    #fileHint { font-size: 11px; color: var(--vscode-descriptionForeground); margin-bottom:6px; display: none; }
    /* Message action buttons (Replay / Copy) — placed outside the bubble */
    .message-actions-sibling { display: flex; gap: 6px; margin: 6px 0 12px 0; justify-content: flex-end; }
    .message-actions-sibling button { width: 36px; height: 28px; padding: 4px; display: inline-flex; align-items: center; justify-content: center; border-radius: 6px; cursor: pointer; background: transparent; border: 1px solid rgba(255,255,255,0.04); color: var(--vscode-foreground); }
    .message-actions-sibling button:hover { background: rgba(255,255,255,0.02); }
    .message-actions-sibling svg { width: 16px; height: 16px; fill: currentColor; }
    .message-separator { height: 1px; background: rgba(128,128,128,0.08); opacity: 1; margin: 12px 0; border-radius: 2px; }
  </style>
</head>
<body>
  <div class="shell">
    <div id="messages" class="messages" aria-live="polite"></div>
    <div class="composer">
      <div id="activeEditorName" style="font-size:12px; font-weight:600; margin-bottom:6px; color:var(--vscode-descriptionForeground);"></div>
      <div id="activeFiles" style="display:flex; gap:6px; flex-wrap:wrap; margin-bottom:6px;"></div>
      <input id="fileSearch" placeholder="Filter files..." style="width:100%; padding:6px; margin-bottom:6px; border-radius:4px; border:1px solid var(--vscode-input-border); background:var(--vscode-input-background); color:var(--vscode-input-foreground);" />
      <div id="fileHint">↑/↓ select — Enter attach</div>
      <div id="fileList" style="display:none; max-height:170px; overflow:auto; margin-bottom:8px; border:1px solid rgba(255,255,255,0.03); padding:6px; border-radius:6px; background:var(--vscode-sideBar-background)"></div>
      <textarea id="prompt" placeholder="Ask your local model..."></textarea>
      <div class="controls">
        <div class="status" id="status" data-level="info">
          <div id="spinner" class="spinner" hidden></div>
          <span id="statusText">Auto Completion is working...</span>
        </div>
        <select id="modeSelect" class="mode-select" aria-label="Send mode">
          <option value="ask">Ask</option>
          <option value="agent">Agent</option>
        </select>
        <button id="send" type="button" class="primary" aria-label="Send prompt">
          <svg class="icon-plane" viewBox="0 0 24 24" role="presentation" focusable="false">
            <path d="M2.4 11.2l17.3-7.7c.9-.4 1.8.5 1.4 1.4L13.4 22.2c-.4.9-1.8.8-2-.2l-1.7-6.1-6.1-1.7c-1-.3-1.1-1.6-.2-2zM18 6.6L6.9 11.5l3.5 1 .9 3.5L18 6.6z"></path>
          </svg>
          <span>Send</span>
        </button>
      </div>
    </div>
  </div>

  <script nonce="__NONCE__">
    (function () {
      // HostBridge: normalize messaging between VS Code (acquireVsCodeApi)
      // and Visual Studio / WebView2 (chrome.webview). Use HostBridge.postMessage
      // and HostBridge.onMessage in the UI code so the same HTML can run on both hosts.
      var HostBridge = (function () {
        var vscodeApi = null;
        try {
          if (typeof acquireVsCodeApi === 'function') {
            vscodeApi = acquireVsCodeApi();
          }
        } catch (e) { /* not VS Code */ }

        function postMessage(msg) {
          try {
            if (vscodeApi && typeof vscodeApi.postMessage === 'function') {
              vscodeApi.postMessage(msg);
              return;
            }
            if (window.chrome && chrome.webview && typeof chrome.webview.postMessage === 'function') {
              chrome.webview.postMessage(msg);
              return;
            }
            console.warn('HostBridge: no host API available to post message', msg);
          } catch (e) {
            console.error('HostBridge.postMessage error', e);
          }
        }

        function onMessage(cb) {
          // VS Code messages arrive via window 'message' event with data in event.data
          window.addEventListener('message', function (ev) {
            try { cb(ev && ev.data ? ev.data : ev); } catch (e) { console.error(e); }
          });

          // WebView2 messages via chrome.webview
          try {
            if (window.chrome && chrome.webview && typeof chrome.webview.addEventListener === 'function') {
              chrome.webview.addEventListener('message', function (ev) {
                try { cb(ev && ev.data ? ev.data : ev); } catch (e) { console.error(e); }
              });
            }
          } catch (e) { /* ignore if not present */ }
        }

        return { postMessage, onMessage };
      })();

      var messages = document.getElementById('messages');
      var promptInput = document.getElementById('prompt');
      var sendBtn = document.getElementById('send');
      var modeSelect = document.getElementById('modeSelect');
      var statusRoot = document.getElementById('status');
      var statusText = document.getElementById('statusText');
      var spinner = document.getElementById('spinner');
      var fileLabel = document.getElementById('fileLabel');
      var activeEditorName = document.getElementById('activeEditorName');
      var activeFilesRoot = document.getElementById('activeFiles');
      var fileSearch = document.getElementById('fileSearch');
      var fileListRoot = document.getElementById('fileList');
      var fileHint = document.getElementById('fileHint');

      if (!messages || !promptInput || !sendBtn || !statusRoot || !statusText || !spinner || !activeEditorName || !activeFilesRoot || !fileSearch || !fileListRoot || !fileHint || !modeSelect) {
        var missing = [];
        if (!messages) missing.push('messages');
        if (!promptInput) missing.push('prompt');
        if (!sendBtn) missing.push('send');
        if (!statusRoot) missing.push('status');
        if (!statusText) missing.push('statusText');
        if (!spinner) missing.push('spinner');
        if (!modeSelect) missing.push('modeSelect');
        if (!fileLabel) missing.push('fileLabel (optional)');
        if (!activeEditorName) missing.push('activeEditorName');
        if (!activeFilesRoot) missing.push('activeFiles');
        if (!fileSearch) missing.push('fileSearch');
        if (!fileListRoot) missing.push('fileList');
        if (!fileHint) missing.push('fileHint');

        // Console with structure for devtools
        console.error('Lucid Chat: missing required DOM nodes:', missing.join(', '), {
          messagesPresent: !!messages,
          promptPresent: !!promptInput,
          sendPresent: !!sendBtn,
          statusPresent: !!statusRoot,
          statusTextPresent: !!statusText,
          spinnerPresent: !!spinner,
          modeSelectPresent: !!modeSelect,
          fileLabelPresent: !!fileLabel,
          fileHintPresent: !!fileHint,
          fileListPresent: !!fileListRoot
        });

        // Notify extension host for centralized logging / telemetry
        try {
          HostBridge.postMessage({ type: 'error', text: 'Webview initialization failed: missing DOM nodes', nodes: missing });
        } catch (e) { /* ignore post failures */ }

        // Try to show a visible error in the messages pane if available
        try {
          if (messages) {
            var errBlock = document.createElement('div');
            errBlock.className = 'message error';
            var lbl = document.createElement('div');
            lbl.className = 'message-label';
            lbl.textContent = 'Error';
            errBlock.appendChild(lbl);
            var body = document.createElement('div');
            body.className = 'message-body';
            body.textContent = 'Webview failed to initialize. Missing nodes: ' + missing.join(', ');
            errBlock.appendChild(body);
            messages.appendChild(errBlock);
          }
        } catch (e) { /* ignore UI errors */ }

        return;
      }

      promptInput.disabled = false;
      sendBtn.disabled = false;

      function setEditorLabel(text) {
        try {
          if (fileLabel) fileLabel.textContent = text || '';
          if (activeEditorName) activeEditorName.textContent = text || '';
        } catch (e) { /* ignore */ }
      }

      var actionToolbarMenus = [];
      function closeAllActionToolbarMenus(except) {
        for (var i = 0; i < actionToolbarMenus.length; i++) {
          var menuHost = actionToolbarMenus[i];
          if (!menuHost) continue;
          if (except && menuHost === except) continue;
          menuHost.classList.remove('open');
        }
      }

      document.addEventListener('click', function (ev) {
        var target = ev.target;
        if (!target) return;
        var host = target.closest ? target.closest('.action-toolbar-more') : null;
        if (!host) {
          closeAllActionToolbarMenus();
        }
      });

      function createToolbarButton(label, svg, onClick, title, disabled) {
        var btn = document.createElement('button');
        btn.type = 'button';
        btn.title = title || label;
        btn.setAttribute('aria-label', title || label);
        btn.innerHTML = svg + '<span>' + label + '</span>';
        btn.disabled = !!disabled;
        if (!disabled) {
          btn.addEventListener('click', onClick);
        }
        return btn;
      }

      function iconSvg(path) {
        return '<svg class="action-toolbar-icon" viewBox="0 0 24 24" role="img" aria-hidden="true"><path d="' + path + '"></path></svg>';
      }

      function copyPlainText(text, successMessage) {
        if (!text) return;
        function success() { setStatus(successMessage || 'Copied', 'info', false); }
        function failure(err) { console.error(err); setStatus('Copy failed', 'error', false); }
        if (navigator && navigator.clipboard && typeof navigator.clipboard.writeText === 'function') {
          navigator.clipboard.writeText(text).then(success).catch(failure);
        } else {
          var ta = document.createElement('textarea');
          ta.value = text;
          document.body.appendChild(ta);
          ta.select();
          try {
            document.execCommand('copy');
            success();
          } catch (e) {
            failure(e);
          }
          document.body.removeChild(ta);
        }
      }

      function createActionToolbar(preview, jsonBlock) {
        var toolbar = document.createElement('div');
        toolbar.className = 'action-code-toolbar';
        var hasSnippet = !!(preview.snippet && preview.snippet.length);
        var actionId = preview.actionId || '';
        var actionType = (preview.actionType || '').toLowerCase();

        function triggerRun() {
          if (!actionId) return;
          HostBridge.postMessage({ type: 'actionRun', actionId: actionId });
        }

        var runLabel = actionType === 'terminal' ? 'Run in Terminal' : 'Execute Action';
        var runTitle = actionType === 'terminal'
          ? 'Open a terminal and run this command'
          : 'Execute the VS Code or clipboard action';
        var runBtn = createToolbarButton(runLabel, iconSvg('M8 5v14l11-7z'), triggerRun, runTitle, !actionId);
        runBtn.classList.add('action-primary');
        toolbar.appendChild(runBtn);

        if (actionType !== 'terminal') {
          var applyBtn = createToolbarButton('Apply in Editor', iconSvg('M12 2l4 4h-3v9h-2V6H8l4-4zM5 20v-7H3v9h18v-9h-2v7H5z'), function () {
            HostBridge.postMessage({ type: 'previewApplySnippet', snippet: preview.snippet });
          }, 'Replace the current selection or document with this snippet', !hasSnippet);

          var insertBtn = createToolbarButton('Insert at Cursor', iconSvg('M11 2v9H8l4 4 4-4h-3V2h-2zm-6 11h2v7h10v-7h2v9H5v-9z'), function () {
            HostBridge.postMessage({ type: 'previewInsertSnippet', snippet: preview.snippet });
          }, 'Insert snippet at the current cursor (Ctrl+Enter)', !hasSnippet);

          toolbar.appendChild(applyBtn);
          toolbar.appendChild(insertBtn);
        }

        var copySource = preview.snippet || preview.command || preview.rawJson || '';
        var copyBtn = createToolbarButton('Copy', iconSvg('M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z'), function () {
          copyPlainText(copySource, 'Action copied');
        }, 'Copy the snippet or command to the clipboard', !copySource.length);
        toolbar.appendChild(copyBtn);

        var moreHost = document.createElement('div');
        moreHost.className = 'action-toolbar-more';
        var moreBtn = createToolbarButton('More', iconSvg('M5 12a2 2 0 110-4 2 2 0 010 4zm7 0a2 2 0 110-4 2 2 0 010 4zm7 0a2 2 0 110-4 2 2 0 010 4z'), function (ev) {
          ev.stopPropagation();
          if (moreHost.classList.contains('open')) {
            moreHost.classList.remove('open');
          } else {
            closeAllActionToolbarMenus(moreHost);
            moreHost.classList.add('open');
          }
        }, 'More actions', false);
        var moreLabel = moreBtn.querySelector('span');
        if (moreLabel) moreLabel.style.display = 'none';

        var menu = document.createElement('div');
        menu.className = 'action-toolbar-more-menu';
        var toggleJsonBtn = document.createElement('button');
        toggleJsonBtn.type = 'button';
        toggleJsonBtn.textContent = jsonBlock ? 'Show JSON payload' : 'JSON payload unavailable';
        toggleJsonBtn.disabled = !jsonBlock;
        toggleJsonBtn.addEventListener('click', function () {
          if (!jsonBlock) return;
          var isHidden = jsonBlock.hasAttribute('hidden');
          if (isHidden) {
            jsonBlock.removeAttribute('hidden');
            toggleJsonBtn.textContent = 'Hide JSON payload';
          } else {
            jsonBlock.setAttribute('hidden', 'true');
            toggleJsonBtn.textContent = 'Show JSON payload';
          }
          moreHost.classList.remove('open');
        });
        menu.appendChild(toggleJsonBtn);

        var copyJsonBtn = document.createElement('button');
        copyJsonBtn.type = 'button';
        copyJsonBtn.textContent = 'Copy JSON payload';
        copyJsonBtn.disabled = !preview.rawJson;
        copyJsonBtn.addEventListener('click', function () {
          if (!preview.rawJson) return;
          copyPlainText(preview.rawJson, 'Action JSON copied');
          moreHost.classList.remove('open');
        });
        menu.appendChild(copyJsonBtn);

        moreHost.appendChild(moreBtn);
        moreHost.appendChild(menu);
        actionToolbarMenus.push(moreHost);
        toolbar.appendChild(moreHost);

        return toolbar;
      }

      function createActionPreview(preview) {
        if (!preview) return null;
        var card = document.createElement('div');
        card.className = 'action-preview-card';

        var header = document.createElement('div');
        header.className = 'action-preview-header';

        var typeBadge = document.createElement('div');
        typeBadge.className = 'action-preview-type';
        typeBadge.textContent = preview.typeLabel || 'Action';
        header.appendChild(typeBadge);

        card.appendChild(header);

        if (preview.description) {
          var desc = document.createElement('div');
          desc.className = 'action-preview-desc';
          desc.textContent = preview.description;
          card.appendChild(desc);
        }

        var code = document.createElement('pre');
        code.className = 'action-preview-code';
        code.setAttribute('data-lang', preview.language || 'text');
        code.textContent = preview.snippet || '';
        card.appendChild(code);

        var jsonBlock = null;
        if (preview.rawJson) {
          jsonBlock = document.createElement('pre');
          jsonBlock.className = 'action-json-block';
          jsonBlock.textContent = preview.rawJson;
          jsonBlock.setAttribute('hidden', 'true');
        }

        var toolbar = createActionToolbar(preview, jsonBlock);
        if (toolbar) card.appendChild(toolbar);
        if (jsonBlock) card.appendChild(jsonBlock);

        return card;
      }

      function createAutoEditReview(review) {
        if (!review || !review.id) return null;
        var card = document.createElement('div');
        card.className = 'auto-edit-review';
        card.setAttribute('data-review-id', review.id);
        if (review.status) card.dataset.state = review.status;

        var head = document.createElement('div');
        head.className = 'auto-edit-head';

        var summary = document.createElement('div');
        summary.className = 'auto-edit-summary';
        var title = document.createElement('div');
        title.className = 'auto-edit-summary-title';
        title.textContent = '1 file changed';
        summary.appendChild(title);
        var subtitle = document.createElement('div');
        subtitle.className = 'auto-edit-summary-desc';
        var fallback = review.path || review.fileName || 'editor action';
        if (review.command) {
          fallback += ' • ' + review.command;
        }
        subtitle.textContent = review.description || fallback;
        summary.appendChild(subtitle);
        head.appendChild(summary);

        var toolbar = document.createElement('div');
        toolbar.className = 'auto-edit-actions';

        var keepBtn = document.createElement('button');
        keepBtn.type = 'button';
        keepBtn.classList.add('primary');
        keepBtn.textContent = 'Keep';
        keepBtn.dataset.role = 'keep';
        keepBtn.addEventListener('click', function () {
          HostBridge.postMessage({ type: 'autoEditKeep', reviewId: review.id });
        });
        toolbar.appendChild(keepBtn);

        var undoBtn = document.createElement('button');
        undoBtn.type = 'button';
        undoBtn.classList.add('undo');
        undoBtn.textContent = 'Undo';
        undoBtn.dataset.role = 'undo';
        undoBtn.addEventListener('click', function () {
          HostBridge.postMessage({ type: 'autoEditUndo', reviewId: review.id });
        });
        toolbar.appendChild(undoBtn);

        var viewBtn = document.createElement('button');
        viewBtn.type = 'button';
        viewBtn.textContent = 'View';
        viewBtn.addEventListener('click', function () {
          HostBridge.postMessage({ type: 'autoEditView', reviewId: review.id });
        });
        toolbar.appendChild(viewBtn);

        head.appendChild(toolbar);
        card.appendChild(head);

        var fileRow = document.createElement('div');
        fileRow.className = 'auto-edit-file';
        var filePath = document.createElement('div');
        filePath.className = 'auto-edit-file-path';
        filePath.textContent = review.path || review.fileName || 'Active editor';
        fileRow.appendChild(filePath);
        var stats = document.createElement('div');
        stats.className = 'auto-edit-file-stats';
        var added = document.createElement('span');
        added.className = 'added';
        added.textContent = `+${typeof review.added === 'number' ? review.added : 0}`;
        stats.appendChild(added);
        var removed = document.createElement('span');
        removed.className = 'removed';
        removed.textContent = `-${typeof review.removed === 'number' ? review.removed : 0}`;
        stats.appendChild(removed);
        fileRow.appendChild(stats);
        card.appendChild(fileRow);

        var diffBlock = createDiffBlock(review.diff || '');
        card.appendChild(diffBlock);

        var status = document.createElement('div');
        status.className = 'auto-edit-review-status';
        if (review.status === 'kept') {
          status.textContent = 'Marked as kept.';
        } else if (review.status === 'undone') {
          status.textContent = 'Marked as undone.';
        } else {
          status.textContent = 'Review the diff and choose Keep or Undo.';
        }
        card.appendChild(status);

        return card;
      }

      function updateAutoEditReviewStatus(payload) {
        if (!payload || !payload.reviewId) return;
        var block = document.querySelector('.auto-edit-review[data-review-id="' + payload.reviewId + '"]');
        if (!block) return;
        if (payload.message) {
          var status = block.querySelector('.auto-edit-review-status');
          if (status) status.textContent = payload.message;
        }
        var controlButtons = block.querySelectorAll('button[data-role="keep"], button[data-role="undo"]');
        for (var i = 0; i < controlButtons.length; i++) {
          controlButtons[i].disabled = true;
        }
        if (payload.status) {
          block.dataset.state = payload.status;
        }
      }

      function createDiffBlock(diffText) {
        var wrapper = document.createElement('pre');
        wrapper.className = 'diff-view';
        if (!diffText) {
          wrapper.textContent = '(no diff)';
          return wrapper;
        }
        var lines = diffText.replace(/\r\n/g, '\n').split('\n');
        for (var i = 0; i < lines.length; i++) {
          var line = document.createElement('span');
          line.className = 'diff-line';
          var content = lines[i] || '';
          if (content.startsWith('+')) {
            line.classList.add('add');
          } else if (content.startsWith('-')) {
            line.classList.add('remove');
          } else if (content.startsWith('diff') || content.startsWith('---') || content.startsWith('+++')) {
            line.classList.add('meta');
          }
          line.textContent = content;
          wrapper.appendChild(line);
        }
        return wrapper;
      }

        function createActionOutput(actionResult, defaultOpen) {
          try {
            if (!actionResult) return null;
            var container = document.createElement('div');
            container.className = 'action-output';
            container.classList.add(actionResult.success === false ? 'error' : 'success');

            var commandLine = buildCommandLine(actionResult);

            var toggle = document.createElement('button');
            toggle.type = 'button';
            toggle.className = 'action-output-toggle';
            toggle.setAttribute('aria-expanded', 'false');

            var heading = document.createElement('div');
            heading.className = 'action-output-heading';
            var title = document.createElement('span');
            title.className = 'action-output-title';
            title.textContent = 'Terminal';
            heading.appendChild(title);

            var commandLabel = document.createElement('span');
            commandLabel.className = 'action-output-command';
            var commandText = commandLine.length ? commandLine : (actionResult.title || '');
            commandLabel.textContent = commandText || '—';
            if (commandText) commandLabel.title = commandText;
            heading.appendChild(commandLabel);
            toggle.appendChild(heading);

            var status = document.createElement('span');
            status.className = 'action-output-status ' + (actionResult.success === false ? 'error' : 'ok');
            status.textContent = actionResult.success === false ? 'Failed' : 'Completed';
            toggle.appendChild(status);

            var icon = document.createElement('span');
            icon.className = 'action-output-icon';
            icon.innerHTML = '&#9656;';
            toggle.appendChild(icon);

            var body = document.createElement('div');
            body.className = 'action-output-body';
            var startOpen = !!defaultOpen;
            body.hidden = !startOpen;

            toggle.addEventListener('click', function () {
              var expanded = body.hidden === false;
              if (expanded) {
                body.hidden = true;
                container.classList.remove('open');
                toggle.setAttribute('aria-expanded', 'false');
              } else {
                body.hidden = false;
                container.classList.add('open');
                toggle.setAttribute('aria-expanded', 'true');
              }
            });

            container.appendChild(toggle);
            container.appendChild(body);
            toggle.setAttribute('aria-expanded', startOpen ? 'true' : 'false');
            if (startOpen) {
              container.classList.add('open');
            }

            var meta = document.createElement('div');
            meta.className = 'action-output-meta';
            if (commandLine.length) meta.appendChild(createMetaEntry('Command', commandLine));
            if (actionResult.cwd) meta.appendChild(createMetaEntry('Working dir', actionResult.cwd));
            if (typeof actionResult.exitCode !== 'undefined') meta.appendChild(createMetaEntry('Exit code', String(actionResult.exitCode)));
            if (meta.children.length) body.appendChild(meta);

            var hasStdout = typeof actionResult.stdout === 'string' && actionResult.stdout.trim().length > 0;
            var hasStderr = typeof actionResult.stderr === 'string' && actionResult.stderr.trim().length > 0;
            var stdoutSection = createActionOutputSection('stdout', actionResult.stdout || '');
            var stderrSection = createActionOutputSection('stderr', actionResult.stderr || '');
            if (hasStdout && stdoutSection) body.appendChild(stdoutSection);
            if (hasStderr && stderrSection) body.appendChild(stderrSection);
            if (!hasStdout && !hasStderr) {
              var empty = document.createElement('div');
              empty.className = 'action-output-empty';
              empty.textContent = 'No output captured for this command.';
              body.appendChild(empty);
            }

            if (Array.isArray(actionResult.suggestions) && actionResult.suggestions.length > 0) {
              var suggestionBlock = document.createElement('div');
              suggestionBlock.className = 'action-output-suggestions';
              var titleEl = document.createElement('strong');
              titleEl.textContent = 'Next steps';
              suggestionBlock.appendChild(titleEl);
              var list = document.createElement('ul');
              for (var i = 0; i < actionResult.suggestions.length; i++) {
                var item = document.createElement('li');
                item.textContent = actionResult.suggestions[i];
                list.appendChild(item);
              }
              suggestionBlock.appendChild(list);
              body.appendChild(suggestionBlock);
            }

            return container;
          } catch (e) {
            console.error(e);
            return null;
          }
        }

        function estimateActionOutputLength(result) {
          if (!result) return 0;
          var total = 0;
          var textFields = ['command', 'cwd', 'stdout', 'stderr'];
          for (var i = 0; i < textFields.length; i++) {
            var key = textFields[i];
            if (result[key] && typeof result[key] === 'string') {
              total += result[key].length;
            }
          }
          if (Array.isArray(result.args) && result.args.length) {
            total += result.args.join(' ').length;
          }
          if (typeof result.exitCode !== 'undefined') {
            total += String(result.exitCode).length;
          }
          if (Array.isArray(result.suggestions) && result.suggestions.length) {
            total += result.suggestions.join(' ').length;
          }
          return total;
        }

        function buildCommandLine(result) {
          var parts = [];
          if (result.command) parts.push(result.command);
          if (Array.isArray(result.args)) {
            for (var i = 0; i < result.args.length; i++) {
              if (typeof result.args[i] === 'string') {
                parts.push(result.args[i]);
              }
            }
          }
          return parts.join(' ').trim();
        }

        function createMetaEntry(label, value) {
          var entry = document.createElement('div');
          var heading = document.createElement('strong');
          heading.textContent = label;
          entry.appendChild(heading);
          var text = document.createElement('div');
          text.textContent = value;
          entry.appendChild(text);
          return entry;
        }

        function createActionOutputSection(label, content) {
          if (!content || !content.trim()) return null;
          var section = document.createElement('div');
          section.className = 'action-output-section';
          var header = document.createElement('div');
          header.className = 'action-output-section-header';
          header.textContent = label.toUpperCase();
          var copyBtn = document.createElement('button');
          copyBtn.type = 'button';
          copyBtn.textContent = 'Copy';
          copyBtn.addEventListener('click', function (ev) {
            ev.stopPropagation();
            copyPlainText(content, label.toUpperCase() + ' copied');
          });
          header.appendChild(copyBtn);
          section.appendChild(header);
          var pre = document.createElement('pre');
          pre.textContent = content;
          section.appendChild(pre);
          return section;
        }

        function createTodoList(todo) {
          try {
            if (!todo || !Array.isArray(todo.items) || todo.items.length === 0) return null;
            var card = document.createElement('div');
            card.className = 'todo-card';

            var header = document.createElement('div');
            header.className = 'todo-card-header';
            var title = document.createElement('div');
            title.className = 'todo-card-title';
            title.textContent = todo.title || 'Önerilen adımlar';
            header.appendChild(title);
            if (todo.description) {
              var desc = document.createElement('div');
              desc.className = 'todo-card-desc';
              desc.textContent = todo.description;
              header.appendChild(desc);
            }
            card.appendChild(header);

            var list = document.createElement('ol');
            list.className = 'todo-list';
            for (var i = 0; i < todo.items.length; i++) {
              var item = todo.items[i];
              var row = document.createElement('li');
              row.className = 'todo-item';

              var main = document.createElement('div');
              main.className = 'todo-item-main';
              var index = document.createElement('div');
              index.className = 'todo-item-index';
              index.textContent = (i + 1) + '.';
              main.appendChild(index);

              var checkbox = document.createElement('input');
              checkbox.type = 'checkbox';
              checkbox.className = 'todo-item-check';
              var checkboxId = (item.id || ('todo-' + Date.now() + '-' + i));
              checkbox.id = checkboxId;
              main.appendChild(checkbox);

              var label = document.createElement('label');
              label.setAttribute('for', checkboxId);
              label.className = 'todo-item-title';
              label.textContent = item.title || 'Adım ' + (i + 1);
              main.appendChild(label);
              row.appendChild(main);

              if (item.detail) {
                var detail = document.createElement('div');
                detail.className = 'todo-item-detail';
                detail.textContent = item.detail;
                row.appendChild(detail);
              }

              var actions = document.createElement('div');
              actions.className = 'todo-item-actions';
              if (item.snippet) {
                var snippet = document.createElement('pre');
                snippet.className = 'todo-item-snippet';
                snippet.textContent = item.snippet;
                actions.appendChild(snippet);
              }
              if (item.actionId) {
                var runBtn = document.createElement('button');
                runBtn.type = 'button';
                runBtn.textContent = 'Çalıştır';
                runBtn.addEventListener('click', (function (actionId, btn) {
                  return function () {
                    try {
                      btn.disabled = true;
                      btn.textContent = 'Gönderildi';
                      HostBridge.postMessage({ type: 'actionRun', actionId: actionId });
                      setTimeout(function () {
                        btn.disabled = false;
                        btn.textContent = 'Tekrar Çalıştır';
                      }, 6000);
                    } catch (err) { console.error(err); }
                  };
                })(item.actionId, runBtn));
                actions.appendChild(runBtn);
              }
              if (actions.children.length) {
                row.appendChild(actions);
              }
              list.appendChild(row);
            }
            card.appendChild(list);
            return card;
          } catch (e) {
            console.error(e);
            return null;
          }
        }

        function estimateTodoListLength(todo) {
          if (!todo || !Array.isArray(todo.items)) return 0;
          var total = 0;
          if (todo.title) total += todo.title.length;
          if (todo.description) total += todo.description.length;
          for (var i = 0; i < todo.items.length; i++) {
            var item = todo.items[i];
            if (item.title) total += item.title.length;
            if (item.detail) total += item.detail.length;
            if (item.snippet) total += item.snippet.length;
          }
          return total;
        }

      // File list render + interaction
      var currentFiles = [];
      var currentAttached = [];
      var dropdownRows = [];
      var dropdownSelected = -1;
      function renderFileList(files, attached) {
        try {
          if (!Array.isArray(files)) files = [];
          const attachedSet = new Set(attached || []);
          fileListRoot.innerHTML = '';
          // If we have no files but some attached entries, show attached ones
          if ((!files || files.length === 0) && (!attached || attached.length === 0)) {
            fileListRoot.textContent = 'No workspace files found';
            return;
          }

          // normalize filter
          var filter = '';
          try { filter = (fileSearch && fileSearch.value) ? String(fileSearch.value).toLowerCase().trim() : ''; } catch (e) { filter = ''; }

          // If no filter, hide the results dropdown (do not show full list)
          if (!filter) {
            try { fileListRoot.innerHTML = ''; fileListRoot.style.display = 'none'; if (fileHint) fileHint.style.display = 'none'; } catch (e) { }
            return;
          }

          // show the results container and keyboard hint
          try { fileListRoot.style.display = 'block'; if (fileHint) fileHint.style.display = 'block'; } catch (e) { }

          var visibleIndex = 0;
          dropdownRows = [];

          for (const f of files) {
            var nm = (f.name || f.path || '').toLowerCase();
            if (nm.indexOf(filter) === -1) continue;
            const row = document.createElement('div');
            row.style.display = 'flex';
            row.style.alignItems = 'center';
            row.style.justifyContent = 'space-between';
            row.style.padding = '2px 4px';

            const left = document.createElement('div');
            left.style.display = 'flex';
            left.style.alignItems = 'center';

            const name = document.createElement('div');
            name.textContent = f.name || f.path;
            name.title = f.path;
            name.style.marginRight = '8px';

            const badge = document.createElement('div');
            badge.style.width = '18px';
            badge.style.height = '18px';
            badge.style.display = 'inline-flex';
            badge.style.alignItems = 'center';
            badge.style.justifyContent = 'center';
            badge.style.cursor = 'pointer';

            const isAttached = attachedSet.has(f.path);
            if (isAttached) {
              badge.textContent = '✔';
              badge.title = 'Attached';
              badge.style.opacity = '0.9';
              badge.onclick = null;
            } else {
              badge.textContent = '+';
              badge.title = 'Add to selection';
              badge.onclick = () => { HostBridge.postMessage({ type: 'attach', path: f.path }); };
            }

            // Place the badge inline after the filename
            left.appendChild(name);
            left.appendChild(badge);
            row.appendChild(left);

            // accessibility / keyboard target
            row.className = 'file-list-item';
            row.tabIndex = 0;
            row.dataset.index = String(visibleIndex);
            row.dataset.path = f.path;
            // mouse enter selects
            row.addEventListener('mouseenter', function () { setDropdownSelected(Number(row.dataset.index)); });
            // click to attach (if not attached)
            row.addEventListener('click', function () {
              try {
                if (!attachedSet.has(f.path)) {
                  HostBridge.postMessage({ type: 'attach', path: f.path });
                  // hide dropdown and clear search for clarity
                  try { if (fileListRoot) fileListRoot.style.display = 'none'; } catch (_) { }
                }
              } catch (e) { }
            });

            dropdownRows.push(row);
            visibleIndex++;

            fileListRoot.appendChild(row);
          }
          // ensure only up to N visible without scrolling (CSS handles scroll). nothing else to do here.
          if (dropdownSelected >= dropdownRows.length) dropdownSelected = dropdownRows.length - 1;
          updateDropdownFocus();
        } catch (e) { /* ignore rendering errors */ }
      }

      function setDropdownSelected(idx) {
        try {
          dropdownSelected = typeof idx === 'number' ? idx : -1;
          updateDropdownFocus();
        } catch (e) { }
      }

      function updateDropdownFocus() {
        try {
          for (var i = 0; i < dropdownRows.length; i++) {
            var r = dropdownRows[i];
            if (!r) continue;
            if (i === dropdownSelected) {
              r.classList.add('focused');
              try { r.scrollIntoView({ block: 'nearest' }); } catch (e) { }
            } else {
              r.classList.remove('focused');
            }
          }
        } catch (e) { }
      }

      function renderAttachedPills(attached) {
        try {
          if (!activeFilesRoot) return;
          activeFilesRoot.innerHTML = '';
          if (!Array.isArray(attached) || attached.length === 0) return;
          for (const p of attached) {
            var base = p.split('/').pop();
            var pill = document.createElement('div');
            pill.style.display = 'inline-flex';
            pill.style.alignItems = 'center';
            pill.style.gap = '6px';
            pill.style.padding = '4px 8px';
            pill.style.borderRadius = '999px';
            pill.style.border = '1px solid var(--vscode-input-border)';
            pill.style.color = 'var(--vscode-input-foreground)';
            pill.style.fontSize = '12px';

            var txt = document.createElement('span');
            txt.textContent = base || p;
            txt.title = p;
            pill.appendChild(txt);

            var rem = document.createElement('button');
            rem.textContent = '×';
            rem.title = 'Remove attached file';
            rem.style.border = 'none';
            rem.style.background = 'transparent';
            rem.style.cursor = 'pointer';
            rem.style.fontSize = '12px';
            rem.onclick = function () { HostBridge.postMessage({ type: 'detach', path: p }); };
            pill.appendChild(rem);

            activeFilesRoot.appendChild(pill);
          }
        } catch (e) { /* ignore */ }
      }

      // request initial file list
      HostBridge.postMessage({ type: 'requestFiles' });
      if (fileSearch) {
        fileSearch.addEventListener('input', function () {
          try { renderFileList(currentFiles, currentAttached); } catch (e) { }
        });
        // show results on focus as well if the field has content
        fileSearch.addEventListener('focus', function () {
          try { renderFileList(currentFiles, currentAttached); } catch (e) { }
        });
        // hide results if clicking outside (simple handler)
        document.addEventListener('click', function (ev) {
          try {
            var target = ev.target;
            if (!target) return;
            if (target === fileSearch) return;
            // if click inside the fileListRoot, ignore
            if (fileListRoot && fileListRoot.contains && fileListRoot.contains(target)) return;
            // otherwise hide dropdown
            if (fileListRoot) fileListRoot.style.display = 'none';
            if (fileHint) fileHint.style.display = 'none';
          } catch (e) { }
        });
      }
      // keyboard navigation for the dropdown
      if (fileSearch) {
        fileSearch.addEventListener('keydown', function (ev) {
          try {
            if (!dropdownRows || dropdownRows.length === 0) return;
            if (ev.key === 'ArrowDown') {
              ev.preventDefault();
              dropdownSelected = Math.min((dropdownSelected + 1) || 0, dropdownRows.length - 1);
              updateDropdownFocus();
              return;
            }
            if (ev.key === 'ArrowUp') {
              ev.preventDefault();
              dropdownSelected = Math.max((dropdownSelected - 1) || 0, 0);
              updateDropdownFocus();
              return;
            }
            if (ev.key === 'Enter') {
              ev.preventDefault();
              if (dropdownSelected >= 0 && dropdownSelected < dropdownRows.length) {
                var r = dropdownRows[dropdownSelected];
                if (r && r.dataset && r.dataset.path) {
                  HostBridge.postMessage({ type: 'attach', path: r.dataset.path });
                  try { if (fileListRoot) fileListRoot.style.display = 'none'; } catch (_) { }
                }
              }
              return;
            }
            if (ev.key === 'Escape') {
              try { if (fileListRoot) fileListRoot.style.display = 'none'; } catch (_) { }
              return;
            }
          } catch (e) { }
        });
      }

      var state = {
        isStreaming: false,
        isReady: true,
        queue: [],
        raf: null,
        totalChars: 0,
        maxChars: 50000
      };

      function flushQueue() {
        state.raf = null;
        while (state.queue.length) {
          var job = state.queue.shift();
          if (job) job();
        }
      }

      function createWorkflowSummaryCard(summary) {
        try {
          if (!summary) return null;
          var card = document.createElement('div');
          card.className = 'workflow-card';

          var rendered = 0;
          var patchSection = renderWorkflowPatches(summary.patches);
          if (patchSection) { card.appendChild(patchSection); rendered++; }
          var testSection = renderWorkflowTests(summary.tests);
          if (testSection) { card.appendChild(testSection); rendered++; }
          var reportSection = renderWorkflowReport(summary.report);
          if (reportSection) { card.appendChild(reportSection); rendered++; }

          if (!rendered) {
            var empty = document.createElement('div');
            empty.className = 'workflow-empty';
            empty.textContent = 'No workflow details available.';
            card.appendChild(empty);
          }
          return card;
        } catch (e) {
          console.error(e);
          return null;
        }
      }

      function createWorkflowSection(title) {
        var section = document.createElement('div');
        section.className = 'workflow-section';
        var heading = document.createElement('div');
        heading.className = 'workflow-section-title';
        heading.textContent = title;
        section.appendChild(heading);
        return section;
      }

      function focusWorkflowDiff(diffId) {
        if (!diffId) return;
        try {
          var target = document.getElementById('workflow-diff-' + diffId);
          if (!target) return;
          target.scrollIntoView({ behavior: 'smooth', block: 'center' });
          target.classList.add('focused');
          setTimeout(function () { target.classList.remove('focused'); }, 1500);
        } catch (e) { }
      }

      function renderWorkflowPatches(patches) {
        if (!Array.isArray(patches) || patches.length === 0) return null;
        var section = createWorkflowSection('Patches');
        var list = document.createElement('div');
        list.className = 'workflow-patches';
        patches.forEach(function (patch) {
          var row = document.createElement('div');
          row.className = 'workflow-patch';
          var info = document.createElement('div');
          info.className = 'workflow-patch-info';
          var title = document.createElement('div');
          title.textContent = patch.title || patch.actionId;
          info.appendChild(title);
          if (patch.description) {
            var desc = document.createElement('div');
            desc.textContent = patch.description;
            info.appendChild(desc);
          }
          row.appendChild(info);
          var cta = document.createElement('button');
          cta.type = 'button';
          cta.textContent = patch.applied ? 'Applied' : 'Apply Patch';
          cta.disabled = !!patch.applied;
          cta.addEventListener('click', function () {
            HostBridge.postMessage({ type: 'actionRun', actionId: patch.actionId });
          });
          row.appendChild(cta);
          list.appendChild(row);
        });
        section.appendChild(list);
        return section;
      }

      function renderWorkflowTests(tests) {
        if (!Array.isArray(tests) || tests.length === 0) return null;
        var section = createWorkflowSection('Tests');
        var list = document.createElement('div');
        list.className = 'workflow-tests';
        tests.forEach(function (test) {
          var row = document.createElement('div');
          row.className = 'workflow-tests-row';
          var name = document.createElement('div');
          name.className = 'workflow-test-name';
          name.textContent = test.name;
          row.appendChild(name);
          var badge = document.createElement('div');
          badge.className = 'workflow-test-status';
          badge.dataset.status = test.status;
          badge.textContent = test.status;
          row.appendChild(badge);
          if (test.logActionId) {
            var logBtn = document.createElement('button');
            logBtn.type = 'button';
            logBtn.textContent = 'View Log';
            logBtn.addEventListener('click', function () {
              HostBridge.postMessage({ type: 'actionRun', actionId: test.logActionId });
            });
            row.appendChild(logBtn);
          }
          list.appendChild(row);
        });
        section.appendChild(list);
        return section;
      }

      function renderWorkflowReport(report) {
        if (!report) return null;
        var section = createWorkflowSection(report.title || 'Report');
        var card = document.createElement('div');
        card.className = 'workflow-report';
        if (report.highlights && report.highlights.length) {
          var ul = document.createElement('ul');
          ul.className = 'workflow-report-highlights';
          report.highlights.forEach(function (item) {
            var li = document.createElement('li');
            li.textContent = item;
            ul.appendChild(li);
          });
          card.appendChild(ul);
        }
        if (report.metrics && report.metrics.length) {
          var metrics = document.createElement('div');
          metrics.className = 'workflow-metrics';
          report.metrics.forEach(function (metric) {
            var box = document.createElement('div');
            box.className = 'workflow-metric';
            var label = document.createElement('div');
            label.className = 'workflow-metric-label';
            label.textContent = metric.label;
            var value = document.createElement('div');
            value.className = 'workflow-metric-value';
            value.textContent = metric.value;
            box.appendChild(label);
            box.appendChild(value);
            metrics.appendChild(box);
          });
          card.appendChild(metrics);
        }
        if (report.artifacts && report.artifacts.length) {
          var artifacts = document.createElement('div');
          artifacts.className = 'workflow-artifacts';
          report.artifacts.forEach(function (artifact) {
            var btn = document.createElement('button');
            btn.type = 'button';
            btn.textContent = artifact.label;
            if (artifact.url) {
              btn.addEventListener('click', function () {
                HostBridge.postMessage({ type: 'openUrl', url: artifact.url });
              });
            } else if (artifact.actionId) {
              btn.addEventListener('click', function () {
                HostBridge.postMessage({ type: 'actionRun', actionId: artifact.actionId });
              });
            } else {
              btn.disabled = true;
            }
            artifacts.appendChild(btn);
          });
          card.appendChild(artifacts);
        }
        section.appendChild(card);
        return section;
      }

      function enqueue(job) {
        state.queue.push(job);
        if (!state.raf) {
          state.raf = window.requestAnimationFrame(flushQueue);
        }
      }

      function trimOverflow() {
        while (state.totalChars > state.maxChars && messages.firstChild) {
          var first = messages.firstChild;
          var len = Number(first.dataset && first.dataset.textLength ? first.dataset.textLength : first.textContent.length);
          state.totalChars -= len;
          messages.removeChild(first);
        }
      }

      function escapeHtml(str) {
        if (str === void 0 || str === null) return '';
        return String(str)
          .replace(/&/g, '&amp;')
          .replace(/</g, '&lt;')
          .replace(/>/g, '&gt;');
      }

      // Inline code: text surrounded by grave accent (backtick), using \u0060 instead of literal backtick
      var inlineCodePattern = /\u0060([^\u0060]+)\u0060/g;

      function renderInline(line) {
        if (line === void 0 || line === null) line = '';
        var html = escapeHtml(line);
        html = html.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');
        html = html.replace(/\*(.+?)\*/g, '<em>$1</em>');
        html = html.replace(inlineCodePattern, '<code>$1</code>');
        return html;
      }

      // Code fences using three grave accents (no literal backtick in source, use \u0060)
      var fencePattern = /\u0060\u0060\u0060(\w+)?\n([\s\S]*?)\u0060\u0060\u0060/g;

      function renderMarkdown(source) {
        if (!source) return '';

        var codeBlocks = [];
        var fenced = source.replace(fencePattern, function (_m, lang, code) {
          var idx = codeBlocks.length;
          codeBlocks.push({ lang: lang || '', code: code || '' });
          return '\n{{CODE_BLOCK_' + idx + '}}\n';
        });

        var lines = fenced.replace(/\r\n/g, '\n').split('\n');
        var html = '';
        var inList = false;

        function closeList() {
          if (inList) {
            html += '</ul>';
            inList = false;
          }
        }

        for (var i = 0; i < lines.length; i++) {
          var rawLine = lines[i];

          if (rawLine.indexOf('{{CODE_BLOCK_') === 0) {
            closeList();
            var idxMatch = rawLine.match(/\d+/);
            var idx = idxMatch ? Number(idxMatch[0]) : 0;
            var block = codeBlocks[idx];
            var lang = block && block.lang ? block.lang : '';
            var code = escapeHtml(block && block.code ? block.code : '');
            var langClass = lang ? 'language-' + lang.replace(/[^a-z0-9_-]/gi, '') : 'language-plain';
            var langAttr = lang || 'plain';
            html += '<pre class="code-block" data-lang="' + langAttr + '"><code class="' + langClass + '">' + code + '</code></pre>';
            continue;
          }

          // Bullet list (- item / * item)
          if (/^\s*[-*]\s+/.test(rawLine)) {
            var content = rawLine.replace(/^\s*[-*]\s+/, '');
            if (!inList) {
              html += '<ul class="message-list">';
              inList = true;
            }
            html += '<li>' + renderInline(content) + '</li>';
            continue;
          }

          closeList();

          if (rawLine.trim() === '') {
            html += '<br />';
            continue;
          }

          html += '<p>' + renderInline(rawLine) + '</p>';
        }

        closeList();
        return html;
      }

      function labelForRole(role) {
        switch (role) {
          case 'user': return 'You';
          case 'assistant': return 'Assistant';
          case 'system': return 'System';
          case 'error': return 'Error';
          default: return 'Notice';
        }
      }

      function normalizeSendMode(mode) {
        var value = (mode || '').toLowerCase();
        if (value === 'agent') return 'agent';
        return 'ask';
      }

      function appendBlock(text, role, options) {
        if (role === void 0) role = 'assistant';
        var safeText = text || '';
        enqueue(function () {
          // streaming: append to last assistant block if exists
          if (role === 'assistant') {
            var last = messages.lastElementChild;
            if (last && last.classList.contains('assistant')) {
              var body = last.querySelector('.message-body');
              if (body) {
                var prevRaw = last.dataset.rawText || '';
                var nextRaw = prevRaw + safeText;
                var prevLen = Number(last.dataset.textLength || '0');
                var nextLen = nextRaw.length;
                last.dataset.rawText = nextRaw;
                last.dataset.textLength = String(nextLen);
                state.totalChars += (nextLen - prevLen);
                body.innerHTML = renderMarkdown(nextRaw);
                trimOverflow();
                messages.scrollTop = messages.scrollHeight;
                return;
              }
            }
          }

          var block = document.createElement('div');
          var roleClass =
            role === 'error' ? 'message error' :
            role === 'user' ? 'message user' :
            role === 'system' ? 'message system' :
            'message assistant';
          block.className = roleClass;

          var label = document.createElement('div');
          label.className = 'message-label';
          label.textContent = labelForRole(role);
          block.appendChild(label);

          var previewBlock = null;
          var outputBlock = null;
          var outputLength = 0;
          var todoBlock = null;
          var todoLength = 0;
          var workflowBlock = null;
          var workflowLength = 0;
          var autoReviewBlock = null;
          var autoReviewLength = 0;

          try {
            if (options && options.actionPreview) {
              previewBlock = createActionPreview(options.actionPreview);
            }
            if (options && options.actionOutput) {
              outputBlock = createActionOutput(options.actionOutput, true);
              if (outputBlock) {
                outputLength = estimateActionOutputLength(options.actionOutput) || outputBlock.textContent.length;
              }
            }
            if (options && options.todoList) {
              todoBlock = createTodoList(options.todoList);
              if (todoBlock) {
                todoLength = estimateTodoListLength(options.todoList) || todoBlock.textContent.length;
              }
            }
            if (options && options.workflowSummary) {
              workflowBlock = createWorkflowSummaryCard(options.workflowSummary);
              if (workflowBlock) {
                workflowLength = workflowBlock.textContent.length;
              }
            }
            if (options && options.autoEditReview) {
              autoReviewBlock = createAutoEditReview(options.autoEditReview);
              if (autoReviewBlock) {
                autoReviewLength = (options.autoEditReview.diff && options.autoEditReview.diff.length) || autoReviewBlock.textContent.length;
              }
            }
          } catch (e) { console.error(e); }

          var shouldRenderMessage = (safeText && safeText.length > 0) || !!previewBlock || !!autoReviewBlock;
          var bodyEl = null;
          if (shouldRenderMessage) {
            bodyEl = document.createElement('div');
            bodyEl.className = 'message-body';
            bodyEl.innerHTML = renderMarkdown(safeText);
            if (previewBlock) {
              block.classList.add('message-action');
              bodyEl.appendChild(previewBlock);
            }
            if (autoReviewBlock) {
              bodyEl.appendChild(autoReviewBlock);
            }
            block.appendChild(bodyEl);
          }

          // Add Replay / Copy buttons as a sibling element (outside the bubble)
          try {
            if (role === 'user') {
              // after appending the message bubble we'll create a sibling div
              // create a factory for the actions so we can append after the bubble
              block._createActionsSibling = function () {
                try {
                  var actionsDiv = document.createElement('div');
                  actionsDiv.className = 'message-actions-sibling';

                  var replayBtn = document.createElement('button');
                  replayBtn.type = 'button';
                  replayBtn.title = 'Resend (reload) message';
                  replayBtn.setAttribute('aria-label', 'Resend message');
                  // Reload/refresh style icon
                  replayBtn.innerHTML = '<svg fill="#ffffff" width="800px" height="800px" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M23,12A11,11,0,1,1,12,1a10.9,10.9,0,0,1,5.882,1.7l1.411-1.411A1,1,0,0,1,21,2V6a1,1,0,0,1-1,1H16a1,1,0,0,1-.707-1.707L16.42,4.166A8.9,8.9,0,0,0,12,3a9,9,0,1,0,9,9,1,1,0,0,1,2,0Z"/></svg>';
                  replayBtn.onclick = function () {
                    try {
                      var raw = block.dataset.rawText || safeText || '';
                      var originalMode = normalizeSendMode(block.dataset.sendMode || 'ask');
                      HostBridge.postMessage({ type: 'replay', prompt: raw, mode: originalMode });
                    } catch (e) { console.error(e); }
                  };

                  var copyBtn = document.createElement('button');
                  copyBtn.type = 'button';
                  copyBtn.title = 'Copy message to clipboard';
                  copyBtn.setAttribute('aria-label', 'Copy message');
                  copyBtn.innerHTML = '<svg viewBox="0 0 24 24" role="img" aria-hidden="true"><path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"></path></svg>';
                  copyBtn.onclick = function () {
                    try {
                      var txt = block.dataset.rawText || safeText || '';
                      // helper to toggle icon to tick and revert after delay
                      function showTickOnce(btn) {
                        try {
                          // clear existing timer if any
                          if (btn._copyTimer) {
                            clearTimeout(btn._copyTimer);
                            btn._copyTimer = null;
                          }
                          // store original icon markup to restore later
                          if (!btn._origIcon) btn._origIcon = btn.innerHTML;
                          btn.innerHTML = '<svg viewBox="0 0 24 24" role="img" aria-hidden="true"><path d="M9 16.2l-3.5-3.5L4 14.2 9 19.2 20 8.2 18.6 6.8z"></path></svg>';
                          btn.title = 'Copied';
                          btn.setAttribute('aria-label', 'Copied');
                          // revert after 5s
                          btn._copyTimer = setTimeout(function () {
                            try { btn.innerHTML = btn._origIcon || '';
                              btn.title = 'Copy message to clipboard';
                              btn.setAttribute('aria-label', 'Copy message');
                            } catch (e) { }
                            btn._copyTimer = null;
                          }, 5000);
                        } catch (e) { }
                      }

                      if (navigator && navigator.clipboard && typeof navigator.clipboard.writeText === 'function') {
                        navigator.clipboard.writeText(txt).then(function () { setStatus('Copied to clipboard', 'info', false); showTickOnce(copyBtn); }).catch(function (err) { console.error('copy failed', err); setStatus('Copy failed', 'error', false); });
                      } else {
                        var ta = document.createElement('textarea');
                        ta.value = txt;
                        document.body.appendChild(ta);
                        ta.select();
                        try {
                          var ok = document.execCommand('copy');
                          document.body.removeChild(ta);
                          if (ok) { setStatus('Copied to clipboard', 'info', false); showTickOnce(copyBtn); } else { setStatus('Copy failed', 'error', false); }
                        } catch (e) { document.body.removeChild(ta); console.error('clipboard fallback failed', e); setStatus('Copy failed', 'error', false); }
                      }
                    } catch (e) { console.error(e); setStatus('Copy failed', 'error', false); }
                  };

                  actionsDiv.appendChild(replayBtn);
                  actionsDiv.appendChild(copyBtn);
                  return actionsDiv;
                } catch (e) { return null; }
              };
            }
          } catch (e) { /* ignore action wiring errors */ }

          var appended = false;
          if (shouldRenderMessage) {
            block.dataset.rawText = safeText;
            if (options && options.sendMode) {
              block.dataset.sendMode = normalizeSendMode(options.sendMode);
            } else if (!block.dataset.sendMode) {
              block.dataset.sendMode = 'ask';
            }
            block.dataset.textLength = String(safeText.length);
            messages.appendChild(block);
            appended = true;
            // If an actions sibling factory was attached, create and append the sibling
            try {
              if (typeof block._createActionsSibling === 'function') {
                var sibling = block._createActionsSibling();
                if (sibling) messages.appendChild(sibling);
              }
            } catch (e) { /* ignore sibling append errors */ }
            // Append a thin separator after assistant messages only
            try {
              if (role === 'assistant') {
                var sepAfter = document.createElement('div');
                sepAfter.className = 'message-separator';
                sepAfter.setAttribute('aria-hidden', 'true');
                messages.appendChild(sepAfter);
              }
            } catch (e) { }
            state.totalChars += safeText.length;
          }

          if (outputBlock) {
            outputBlock.dataset.textLength = String(outputLength);
            messages.appendChild(outputBlock);
            state.totalChars += outputLength;
            appended = true;
          }

          if (todoBlock) {
            todoBlock.dataset.textLength = String(todoLength);
            messages.appendChild(todoBlock);
            state.totalChars += todoLength;
            appended = true;
          }

          if (workflowBlock) {
            workflowBlock.dataset.textLength = String(workflowLength);
            messages.appendChild(workflowBlock);
            state.totalChars += workflowLength;
            appended = true;
          }

          if (appended) {
            trimOverflow();
            messages.scrollTop = messages.scrollHeight;
          }
        });
      }

      function clearMessages() {
        enqueue(function () {
          messages.textContent = '';
          state.totalChars = 0;
        });
      }

      var clearLogState = { lastLoggedAt: 0 };
      function logIgnoredClearRequest(msg) {
        try {
          var now = Date.now();
          if (now - clearLogState.lastLoggedAt < 250) {
            return;
          }
          clearLogState.lastLoggedAt = now;
          if (console && typeof console.warn === 'function') {
            console.warn('Lucid Chat: ignoring clear request to preserve history', {
              payload: msg
            });
          }
        } catch (_) { /* best-effort dev logging */ }
      }

      function setStatus(text, level, streaming) {
        if (level === void 0) level = 'info';
        if (streaming === void 0) streaming = false;
        statusText.textContent = text;
        statusRoot.dataset.level = level;
        state.isStreaming = streaming;
        spinner.hidden = !streaming;
        updateSendState();
      }

      function setReadyState(ready, message) {
        var fallback = ready ? 'Idle' : 'Waiting for Lucid startup…';
        var text = typeof message === 'string' && message.length ? message : fallback;
        setStatus(text, 'info', false);
      }

      function updateSendState() {
        var hasText = promptInput.value.trim().length > 0;
        promptInput.disabled = state.isStreaming;
        sendBtn.disabled = state.isStreaming || !hasText;
        if (modeSelect) modeSelect.disabled = state.isStreaming;
      }

      setReadyState(true, 'Idle');

      function getSendMode() {
        if (!modeSelect) return 'ask';
        return normalizeSendMode(modeSelect.value);
      }

      function applyModePreference(mode) {
        var preferred = normalizeSendMode(mode);
        if (modeSelect && modeSelect.value !== preferred) {
          modeSelect.value = preferred;
        }
      }

      function sendPrompt() {
        var value = promptInput.value.trim();
        if (!value || state.isStreaming) return;
        var selectedMode = getSendMode();
        setStatus('Sending prompt…', 'info', true);
        appendBlock(value, 'user', { sendMode: selectedMode });
        HostBridge.postMessage({ type: 'send', prompt: value, mode: selectedMode });
        promptInput.value = '';
        updateSendState();
      }

      promptInput.addEventListener('input', updateSendState);
      promptInput.addEventListener('keydown', function (event) {
        if ((event.metaKey || event.ctrlKey) && event.key === 'Enter') {
          event.preventDefault();
          sendPrompt();
        }
      });

      sendBtn.addEventListener('click', sendPrompt);

      if (modeSelect) {
        modeSelect.addEventListener('change', function () {
          var nextMode = getSendMode();
          HostBridge.postMessage({ type: 'modeChanged', mode: nextMode });
        });
      }

      // Use HostBridge to receive messages from either host (VS Code or WebView2)
      HostBridge.onMessage(function (msg) {
        if (!msg) return;
        switch (msg.type) {
          case 'history':
            try {
              var entries = Array.isArray(msg.entries) ? msg.entries : [];
              for (var i = 0; i < entries.length; i++) {
                var entry = entries[i] || {};
                appendBlock(entry.text || '', entry.role || 'assistant', entry.options || undefined);
              }
            } catch (e) { console.error(e); }
            break;
          case 'append':
            appendBlock(msg.text, msg.role || 'assistant', msg.options || undefined);
            break;
          case 'fileList':
            try { currentFiles = msg.files || []; renderFileList(currentFiles, currentAttached); renderAttachedPills(currentAttached); } catch (e) { /* ignore */ }
            break;
          case 'readyState':
            setReadyState(!!msg.ready, msg.message);
            break;
          case 'modePreference':
            applyModePreference(msg.mode);
            break;
          case 'attachedChanged':
            try { currentAttached = msg.files || []; renderFileList(currentFiles, currentAttached); renderAttachedPills(currentAttached); } catch (e) { /* ignore */ }
            break;
          case 'editor':
            setEditorLabel(msg.text || '');
            break;
          case 'clear':
            logIgnoredClearRequest(msg);
            break;
          case 'error':
            appendBlock(msg.text || 'Unknown error', 'error');
            setStatus(msg.text || 'Error', 'error', false);
            break;
          case 'status':
            setStatus(msg.text || 'Idle', msg.level || 'info', !!msg.streaming);
            break;
          case 'autoEditReviewUpdate':
            updateAutoEditReviewStatus(msg);
            break;
        }
      });

      setStatus('Idle', 'info', false);
      updateSendState();
    })();
  </script>
</body>
</html>
